var GRAVITY=.0035,JUMPFORCE=1,MAXSPEED=.6,ACCEL=.2,MAGNITUDEX=2,MAGNITUDEY=.2;class Engine{constructor(e,t,a,l){this.c=e,this.cols=t,this.rows=a,this.cells=[],this.scale=l}create(e,t,a){this.rows=e,this.cols=t,this.scale=a,this.clear();for(let l=0;l<this.rows;l++){this.cells[l]=[];for(let e=0;e<this.cols;e++)this.cells[l][e]=[]}}clear(){this.cells=[]}insert(e){const t=e.getLeft(!0),a=e.getTop(!0),l=e.getRight(!0),i=e.getBottom(!0),n=this.scale,o=Math.floor(t/n),c=Math.ceil(l/n),s=Math.floor(a/n),d=Math.ceil(i/n);for(let t=s;t<d;t++)for(let a=o;a<c;a++)this.makeCell(t,a)&&this.cells[t][a].push(e)}makeCell(e,t){const a=this.cells;return!!a[e]&&(a[e][t]||(this.cells[e][t]=[]),!0)}isColliding(e,t){const a=e.getLeft(!0),l=e.getRight(!0),i=e.getTop(!0),n=e.getBottom(!0),o=t.getLeft(!0),c=t.getRight(!0),s=t.getTop(!0),d=t.getBottom(!0);return!!(a<c&&l>o&&i<d&&n>s)}checkCells(){this.cells.forEach(e=>{e.forEach(e=>{!e||1>=e.length||this.testCellEntities(e)})})}testCellEntities(e){const t=e.length;e.forEach((a,l)=>{for(let i=l+1;i<t;i++){const t=e[i];!this.isColliding(a,t)||a===t||this.resolve(a,t)}})}resolve(e,t){let a=e.dx,l=e.dy,n=t.dx,o=t.dy,c=1;(Math.abs(e.dx)>16||Math.abs(e.dy)>16||Math.abs(t.dx)>16||Math.abs(t.dy)>16)&&(c=10);for(let s=1;s<=c;s++){a=e.dx/c*s,l=e.dy/c*s,n=t.dx/c*s,o=t.dy/c*s;const i=.5*(e.w+t.w),d=.5*(e.h+t.h),r=e.getHalfWidth()+a-(t.getHalfWidth()+n),g=e.getHalfHeight()+l-(t.getHalfHeight()+o);if(Math.abs(r)<=i&&Math.abs(g)<=d){const a=i*g,l=d*r;if(a>l){a>-l?(e.resolve(t,"TOP"),t.resolve(e,"BOTTOM")):(e.resolve(t,"RIGHT"),t.resolve(e,"LEFT"));break}else{a>-l?(e.resolve(t,"LEFT"),t.resolve(e,"RIGHT")):(e.resolve(t,"BOTTOM"),t.resolve(e,"TOP"));break}}}}}class Camera{constructor(e){this.game=e,this.x=0,this.y=0,this.oldX=0,this.oldY=0}update(){const e=this.game,t=e.canvas,a=e.Player,l=e.cfg.scale,i=e.cfg.cols*l,n=e.cfg.rows*l,o=i-t.width,c=n-t.height,s=!!(t.width<i),d=!!(t.height<n),r=a.camX+a.w/2,g=a.camY+a.h/2;let p=-r+t.width/2,m=-g+t.height/2;s||(p=t.width/2-i/2),d||(m=t.height/2-n/2),s&&r<=t.width/2?p=0:s&&r>=i-t.width/2&&(p=-o),d&&g<=t.height/2?m=0:d&&g>=n-t.height/2&&(m=-c),a.isDead?e.translate.x==p&&e.translate.y==m?a.spawn():(e.translate.x=e.utils.lerp(e.translate.x,p,.2),e.translate.y=e.utils.lerp(e.translate.y,m,.2),this.x=e.translate.x,this.y=e.translate.y):(e.translate.x=p,e.translate.y=m,this.x=e.translate.x,this.y=e.translate.y),this.oldX=this.x,this.oldY=this.y}}class PlayWindow{constructor(e){this.game=e,this.list="ontouchstart"in window?["touchstart","touchmove","touchend"]:["mousedown","mousemove","mouseup","keyup","keydown"],this.startTime=0,this.endTime=0,this.pauseStart=0,this.timer=0,this.dt=0}update(e){const t=this.game;if(!t.playing[1])return;this.dt=e;const a=t.cfg,l=a.scale,i=t.canvas,n=t.translate.x,o=t.translate.y,c=t.Player,s=t.Engine,d=t.map,r=d[0].length,g=d.length,p=i.width,m=i.height;s.create(a.rows,a.cols,l),c.isDead||c.hide||(c.move(e),s.insert(c));const h=0<Math.floor(-1*(n/l))-20?Math.floor(-1*(n/l))-20:0,u=0<Math.floor(-1*(o/l))-20?Math.floor(-1*(o/l))-20:0,f=Math.ceil(p/l)+h+40>r?r:Math.ceil(p/l)+h+40,w=Math.ceil(m/l)+u+40>u?g:Math.ceil(m/l)+u+40;["static","dynamic"].map(a=>{const l=t[a];for(let t=u;t<w;t++)for(let a=h;a<f;a++){if(!l[t]||!l[t][a])continue;const i=l[t][a];i.empty||!i.collision||(i.update(e),s.insert(i))}}),s.checkCells(),c.update(e),this.timer=Date.now()-this.startTime}draw(){const e=this.game;if(!e.playing[1])return;const t=e.cfg,a=t.scale,l=e.canvas,i=e.translate.x,n=e.translate.y,o=e.Player,s=e.map,d=e.c,c=s[0].length,r=s.length,g=l.width,p=l.height;d.clearRect(0,0,l.width,l.height),e.Camera.update(),d.save(),d.translate(i,n);const m=0<Math.floor(-1*(i/a))-1?Math.floor(-1*(i/a))-1:0,h=0<Math.floor(-1*(n/a))-1?Math.floor(-1*(n/a))-1:0,u=Math.ceil(g/a)+m+2>c?c:Math.ceil(g/a)+m+2,f=Math.ceil(p/a)+h+2>h?r:Math.ceil(p/a)+h+2;["background","static","dynamic","foreground"].map(t=>{const a=e[t];"dynamic"===t&&o.draw();for(let e=h;e<f;e++)for(let t=m;t<u;t++){if(!a[e]||a[e]&&!a[e][t])continue;const l=a[e][t];l.empty||(!l.collision&&l.update(),l.draw())}}),d.restore(),this.displayTimer()}startTimer(){this.startTime=Date.now(),this.game.Player.hide=!1}pauseTimer(){this.game.playing[0]?(this.pauseStart=Date.now(),this.game.playing[0]=!1,console.log("Pause")):(this.startTime&&(this.startTime-=this.pauseStart-Date.now()),this.game.playing[0]=!0,this.game.resetAnimate=!0,this.game.animate(),console.log("Play")),this.game.canvas.focus()}resetTimer(){this.startTime=0,this.endTime=0,this.pauseStart=0}endTimer(){if(this.endTime=Date.now()-this.startTime,this.game.Player.hide=!0,console.log(getTime(this.endTime)),!(null!=this.game.cfg.time&&this.endTime>=this.game.cfg.time||this.game.cfg.edited)){var e=new XMLHttpRequest;e.open("POST","/scoreMap",!0),e.setRequestHeader("Content-type","application/json"),e.send(JSON.stringify({name:this.game.cfg.name,time:this.endTime}))}}displayTimer(){const e=this.game,t=e.canvas,a=e.c;let l=0<this.endTime?this.endTime:this.timer;0===this.startTime&&(l=0);const i=getTime(l),n=document.getElementById("timer");n&&(n.children[0].innerHTML=i)}start(){console.log("Start window Play"),this.list.forEach(e=>document.addEventListener(e,this,!1));const e=document.getElementById("game"),t=gameMenu(this.game);e.insertBefore(t,this.game.canvas)}end(){console.log("End window Play"),this.list.forEach(e=>document.removeEventListener(e,this,!1));const e=document.getElementById("playMenu"),t=document.getElementById("stylePlay"),a=document.getElementById("timer");e.parentNode.removeChild(e),a.parentNode.removeChild(a),t.parentNode.removeChild(t),this.resetTimer()}gameReset(){const e=this.game;e.init(),e.playing[0]||(e.playing[0]=!0,e.animate()),e.canvas.focus(),this.resetTimer(),e.Player.hide=!1,e.Player.dx=0,e.Player.dy=0}handleEvent(e){let t=`on${e.type}`;if("function"==typeof this[t])return e.preventDefault(),this[t](e)}onkeydown(t){const e=this.game;if(t.preventDefault(),!!e.playing[0]){if(e.Player.keys.hasOwnProperty(t.keyCode)&&(e.Player.keys[t.keyCode]=!0),27==t.keyCode){const t=document.getElementById("playMenu");this.pauseTimer();const a=t.style.width.replace(/[px%]/i,"");t.style.width=0<a?0:"100%",e.canvas.focus()}82==t.keyCode&&this.gameReset()}}onkeyup(t){const e=this.game;t.preventDefault();e.playing[0]&&e.Player.keys.hasOwnProperty(t.keyCode)&&(e.Player.keys[t.keyCode]=!1)}onmousedown(){}onmouseup(){}onmousemove(){}onmouseleave(){const e=this.game;e.playing[0]&&(e.mouse.left=!1,e.mouse.right=!1,e.mouse.middle={click:!1,x:null,y:null})}ontouchstart(t){const e=this.game,a=t.targetTouches.item(0)}ontouchmove(t){const e=this.game,a=t.targetTouches.item(0)}ontouchend(){this.game}}class EditWindow{constructor(e){this.game=e,this.list=["mousedown","mousemove","mouseup","wheel","mouseleave","keyup","keydown"]}update(){const e=this.game;if(!e.playing[1])return;const t=e.cfg.scale,a=e.canvas,l=e.translate.x,i=e.translate.y,n=e.c,o=e.cfg.updateAll,c=e.cfg.updateArr;o&&n.clearRect(0,0,a.width,a.height),n.save(),n.translate(l,i);const s=["background","static","dynamic","foreground"];if(o){const n=Math.ceil(a.width/t),o=Math.ceil(a.height/t),c=0<Math.floor(-1*(l/t))?Math.floor(-1*(l/t)):0,d=0<Math.floor(-1*(i/t))?Math.floor(-1*(i/t)):0;for(let t=d;t<o+d+1;t++)for(let a=c;a<n+c+1;a++)s.forEach(l=>{const i=e[l];if(i[t]&&i[t][a]){const e=i[t][a];e.editUpdate(),e.draw()}});e.cfg.updateAll=!1}else 0<c.length&&(c.forEach(t=>{s.forEach(a=>{const l=e[a];if(l[t.y]&&l[t.y][t.x]){const e=l[t.y][t.x];e.editUpdate(),e.draw()}})}),e.cfg.updateArr=[]);n.restore()}start(){console.log("Start window Edit");const e=document.getElementById("game"),t=toolbar(this.game);e.insertBefore(t,this.game.canvas),this.list.forEach(e=>this.game.canvas.addEventListener(e,this,!1))}end(){this.game.cfg.scale=64,console.log("End window Edit"),this.list.forEach(e=>this.game.canvas.removeEventListener(e,this,!1));const e=document.getElementById("toolbar"),t=document.getElementById("styleEdit");e.parentNode.removeChild(e),t.parentNode.removeChild(t)}handleEvent(e){let t=`on${e.type}`;if("function"==typeof this[t])return e.preventDefault(),this[t](e)}onkeydown(t){const e=this.game;e.playing[0]&&(70!==t.keyCode||(e.mouse.middle={click:!0,x:e.mouse.x,y:e.mouse.y}))}onkeyup(t){const e=this.game;e.playing[0]&&(70!==t.keyCode||(e.mouse.middle={click:!1,x:null,y:null}))}onmousedown(t){const e=this.game;if(e.playing[0]){switch(t.button){case 0:e.mouse.click="left",e.mouse.left=!0;break;case 1:e.mouse.click="middle",e.mouse.middle={click:!0,x:e.mouse.x,y:e.mouse.y};break;case 2:e.mouse.click="right",e.mouse.right=!0;}this.checkForClicks()}}onmouseup(t){const e=this.game;if(e.playing[0])switch(e.mouse.click=null,t.button){case 0:e.mouse.left=!1;break;case 1:e.mouse.middle={click:!1,x:null,y:null};break;case 2:e.mouse.right=!1;}}onwheel(t){const e=this.game;if(t.preventDefault(),!e.playing[0])return;const a=e.mouse,l=e.translate.x,i=e.translate.y,n=e.cfg.scale,o=0<t.wheelDelta?4:-4;8<=n+o&&96>=n+o&&(e.translate.x=a.x-(a.x-l)/n*(n+o),e.translate.y=a.y-(a.y-i)/n*(n+o),e.cfg.oldScale=e.cfg.scale,e.cfg.scale+=o,e.cfg.updateAll=!0)}onmousemove(t){const e=this.game;if(e.playing[0]){const a=e.mouse,l=e.cfg.scale,i=e.translate.x,n=e.translate.y;(e.mouse.x=t.clientX,e.mouse.y=t.clientY,e.mouse.gridX=Math.floor((a.x-i)/l),e.mouse.gridY=Math.floor((a.y-n)/l),a.left||a.right||a.middle.click)&&(a.middle.click&&this.checkForClicks(),a.gridX===a.last.gridX&&a.gridY===a.last.gridY&&a.click===a.last.click||this.checkForClicks())}}onmouseleave(){const e=this.game;e.playing[0]&&(e.mouse.left=!1,e.mouse.right=!1,e.mouse.middle={click:!1,x:null,y:null})}ontouchstart(t){const e=this.game,a=t.targetTouches.item(0)}ontouchmove(t){const e=this.game,a=t.targetTouches.item(0)}ontouchend(){this.game}checkForClicks(){const e=this.game,t=e.mouse.gridX,a=e.mouse.gridY,l=e.mouse,i=e.cfg,n=document.getElementById("selectBlock");let o=["background","static","dynamic","foreground","special"],c=o.indexOf(e.select.layer);4===c&&(c=1);const s=e[o[c]];if(s[a]&&(s[a][t]||0==s[a][t])){const n=s[a][t],d=l.x,r=l.y;l.last.gridX=t,l.last.gridY=a;const g=()=>{if(e.select.block){if(e.select.block[3]){let l=!1;if(o=["background","static","dynamic","foreground"],o.forEach(i=>{const n=e[i],o=n[a][t];e.select.block[3]===o.type&&(l=!0)}),!l)return e.utils.handleError(e.select.block[1],"link")}1===e.select.block[1]?(s[a][t]=new e.select.block[0](t,a,e),i.updateArr.push(...this.game.utils.tileManager.getValue(e,t,a,!1,!1)),i.updateArr.push({x:t,y:a})):4===e.select.block[1]||5===e.select.block[1]?("Wall"===s[a-1][t].type?(s[a-1][t]=new e.Objects.Block[0](t,a-1,e),i.updateArr.push(...this.game.utils.tileManager.getValue(e,t,a-1,!0,!1))):s[a-1][t]=new e.Objects.Block[0](t,a-1,e),"Wall"===s[a][t].type?(s[a][t]=new e.select.block[0](t,a,e),i.updateArr.push(...this.game.utils.tileManager.getValue(e,t,a,!0,!1))):s[a][t]=new e.select.block[0](t,a,e),4===e.select.block[1]&&(e.Player.respawn=[t,a-1]),i.updateArr.push({x:t,y:a-1},{x:t,y:a}),document.dispatchEvent(refreshBlockType)):("Wall"===s[a][t].type?(s[a][t]=new e.select.block[0](t,a,e),i.updateArr.push(...this.game.utils.tileManager.getValue(e,t,a,!0,!1))):s[a][t]=new e.select.block[0](t,a,e),i.updateArr.push({x:t,y:a}))}};if(l.right){if(!s[a][t])return;l.last.click="right","background"!=o[c]&&(e.background[a][t]=new e.Objects.Block[0](t,a,e)),s[a][t]=0,i.updateArr.push(...this.game.utils.tileManager.getValue(e,t,a,!0,!1)),i.updateArr.push({x:t,y:a}),document.dispatchEvent(refreshBlockType)}l.left&&(l.last.click="left",g(t,a)),l.middle.click&&(l.last.click="middle",e.translate.x+=d-l.middle.x,e.translate.y+=r-l.middle.y,l.middle.x=d,l.middle.y=r,i.updateAll=!0)}}}class Block{constructor(e,t,a){this.type="Block",this.game=a,this.x=e,this.y=t,this.w=a.cfg.scale,this.h=a.cfg.scale,this.dx=0,this.dy=0,this.color="#111115",this.empty=!1,this.collision=!1,this.id=0,this.purpose=["Background"],this.link=!1}getLeft(e){const t=this.game.cfg.scale;return this.x*t+(t-this.w)+(e?this.dx:0)}getTop(e){const t=this.game.cfg.scale;return this.y*t+(t-this.h)+(e?this.dy:0)}getRight(e){return this.getLeft(e)+this.w}getBottom(e){return this.getTop(e)+this.h}getHalfWidth(e){return this.getRight(e)-this.w/2}getHalfHeight(e){return this.getBottom(e)-this.h/2}draw(){const e=this.game,t=e.c,a=e.cfg.scale,l=this.x*a+(a-this.w),i=this.y*a+(a-this.h);t.beginPath(),t.fillStyle=this.color,t.rect(l,i,this.w,this.h),t.fill(),"edit"===this.game.mode&&(t.strokeStyle="gray",t.stroke()),t.closePath()}update(){const e=this.game.cfg.scale;this.w=e,this.h=e}editUpdate(){this.update()}collisionLeft(e,t){e.stopLeft(e,t)}collisionTop(e,t){e.stopTop(e,t)}collisionRight(e,t){e.stopRight(e,t)}collisionBottom(e,t){e.stopBottom(e,t)}stopLeft(e,t){t.x=e.getLeft()-t.w,t.dx=0}stopTop(e,t){t.y=e.getTop()-t.h,t.dy=0,t.hasBounced=!1,t.isOnFloor=!0}stopRight(e,t){t.x=e.getRight(),t.dx=0}stopBottom(e,t){t.y=e.getBottom(),t.dy=0}normalCollision(e,t){const a=!!(0>e.dx),l=!!(0<e.dx),i=!!(0>e.dy),n=!!(0<e.dy),o=!("LEFT"!==t),c=!("RIGHT"!==t),s=this.x,d=this.y,r=this.game.utils;n?(!("TOP"!==t)&&this.isColliding(this,e,!1,!0)&&e.collision.top.push({obj:this,callback:this.collisionTop}),o&&l&&(r.catchBlockCollision(s-1,d)&&this.isColliding(r.catchBlockCollision(s-1,d),e,!1,!0)?e.collision.top.push({obj:this,callback:this.collisionTop}):e.collision.left.push({obj:this,callback:this.collisionLeft})),c&&a&&(r.catchBlockCollision(s+1,d)&&this.isColliding(r.catchBlockCollision(s+1,d),e,!1,!0)?e.collision.top.push({obj:this,callback:this.collisionTop}):e.collision.right.push({obj:this,callback:this.collisionRight}))):i?(!("BOTTOM"!==t)&&this.isColliding(this,e,!1,!0)&&e.collision.bottom.push({obj:this,callback:this.collisionBottom}),o&&(r.catchBlockCollision(s-1,d)&&this.isColliding(r.catchBlockCollision(s-1,d),e,!1,!0)?e.collision.bottom.push({obj:this,callback:this.collisionBottom}):e.collision.left.push({obj:this,callback:this.collisionLeft})),c&&(r.catchBlockCollision(s+1,d)&&this.isColliding(r.catchBlockCollision(s+1,d),e,!1,!0)?e.collision.bottom.push({obj:this,callback:this.collisionBottom}):e.collision.right.push({obj:this,callback:this.collisionRight}))):a&&c?e.collision.right.push({obj:this,callback:this.collisionRight}):l&&o&&e.collision.left.push({obj:this,callback:this.collisionLeft})}isColliding(e,t,a,l){const i=e.getLeft(),n=e.getRight(),o=e.getTop(),c=e.getBottom(),s=t.getLeft(a),d=t.getRight(a),r=t.getTop(l),g=t.getBottom(l);return!!(i<d&&n>s&&o<g&&c>r)}}class Player extends Block{constructor(e,t,a,l){super(e,t,l),this.type="Player",this.color="brown",this.name=a,this.h=100,this.w=50,this.camX=this.x,this.camY=this.y,this.hide=!1,this.respawn=[this.x,this.y],this.accel=ACCEL,this.maxSpeed=MAXSPEED,this.gravity=GRAVITY,this.jumpForce=JUMPFORCE,this.native={w:this.w,h:this.h,maxSpeed:this.maxSpeed},this.canJump=!0,this.isOnFloor=!1,this.isDead=!1,this.hasBounced=!1,this.isCrouching=!1,this.keys={38:!1,32:!1,90:!1,83:!1,40:!1,16:!1,39:!1,37:!1,81:!1,68:!1},this.collision={left:[],top:[],right:[],bottom:[]}}getLeft(e){return this.x+(e?this.dx:0)}getRight(e){return this.x+this.w+(e?this.dx:0)}getTop(e){return this.y+(e?this.dy:0)}getBottom(e){return this.y+this.h+(e?this.dy:0)}getHalfWidth(e){return this.x+this.w/2+(e?this.dx:0)}getHalfHeight(e){return this.y+this.h/2+(e?this.dy:0)}init(){this.x=this.respawn[0]*this.game.cfg.scale,this.y=this.respawn[1]*this.game.cfg.scale}jump(){this.isOnFloor&&this.canJump&&(this.dy=-this.jumpForce,this.isOnFloor=!1,this.canJump=!1)}crouch(){this.h=50,this.y+=this.h,this.maxSpeed*=.2,this.isCrouching=!0}uncrouch(){const e=this.game,t=e.cfg,a=Math.floor(this.x/t.scale),l=Math.floor((this.y-this.h)/t.scale),i=this.isColliding(e.static,l,a,this),n=this.isColliding(e.static,l,a+1,this);i||n||(this.y-=this.h,this.h=100,this.maxSpeed=this.native.maxSpeed,this.isCrouching=!1)}die(){this.x=this.respawn[0]*this.game.cfg.scale,this.y=this.respawn[1]*this.game.cfg.scale,this.dx=0,this.dy=0,this.isOnFloor=!1,this.hasBounced=!1,this.isDead=!0}spawn(){this.isDead=!1}draw(){if(!(this.isDead||this.hide)){const e=this.game.c;e.beginPath(),e.rect(this.x,this.y,this.w,this.h),e.fillStyle=this.color,e.fill(),e.closePath()}}move(e){this.isIdle=!0;const t=this.dx,a=this.dy,l=this.isOnFloor,i=this.isCrouching,n=this.maxSpeed,o=this.accel,c=this.keys,s=!!(c[37]||c[81]),d=!!(c[38]||c[32]||c[90]),r=!!(c[39]||c[68]),g=!!(c[40]||c[83]||c[16]);if(!(this.isDead||this.hide)){if(s&&(!(i&&Math.abs(t)>n)&&(this.dx=Math.max(t-o,-n)),this.isIdle=!1),r&&(!(i&&Math.abs(t)>n)&&(this.dx=Math.min(t+o,n)),this.isIdle=!1),s&&r&&(this.dx=0),d?this.jump():this.canJump=!0,!i&&g&&this.crouch(),i&&!g&&this.uncrouch(),this.dy+=this.gravity*e,this.isIdle||i&&Math.abs(t)>n){let a=l?.02:.012;i&&Math.abs(t)>n&&(a=l?.0013:0),this.dx=this.game.utils.lerp(t,0,a*e)}if(0===this.game.window.play.startTime){const e=Object.values(this.keys);e.some(t=>t)&&this.game.window.play.startTimer()}}}resolve(){}update(e){if(!(this.isDead||this.hide)){this.handleCollision(),0<this.dy&&(this.isOnFloor=!1);const t=this.game.cfg.scale,a=this.game.cfg.cols,l=this.game.cfg.rows;0>this.getLeft(!0)?(this.x=0,this.dx=0):this.getRight(!0)>a*t&&(this.x=a*t-this.w,this.dx=0),0>this.getTop(!0)?(this.y=0,this.dy=0):this.getBottom(!0)>l*t&&(this.y=l*t-this.h,this.isOnFloor=!0,this.dy=0),this.x+=this.dx*e,this.y+=this.dy*e,this.camX=this.x,this.camY=this.y,this.isCrouching&&(this.camY-=this.h/2)}}isColliding(e,t,a,l){if(!e[t]||!e[t][a]&&0!=e[t][a])return!0;if("Wall"!=e[t][a].type)return!1;const i=e[t][a],n=i.getLeft(),o=i.getRight(),c=i.getTop(),s=i.getBottom(),d=this.getLeft(),r=this.getRight(),g=l?this.getTop()-this.h:this.getTop(),p=this.getBottom();return!!(n<r&&o>d&&c<p&&s>g)}handleCollision(){const e=this.collision.left,t=this.collision.top,a=this.collision.right,l=this.collision.bottom,i=!!(0<e.length),n=!!(0<t.length),o=!!(0<a.length),c=!!(0<l.length),s={x:this.dx,y:this.dy};if(n){const e={Spikes:!1,BouncingBox:!1,End:!1,Wall:!1};t.forEach(({obj:t,callback:a})=>{e.hasOwnProperty(t.type)&&(e[t.type]={obj:t,callback:a})});const a=Object.values(e),l=a.find(t=>t);l.callback(l.obj,this,{x:this.dx,y:this.dy},s)}c&&l.forEach(({obj:e,callback:t})=>{t(e,this,{x:this.dx,y:this.dy},s)}),i&&e.forEach(({obj:e,callback:t})=>{t(e,this,{x:this.dx,y:this.dy},s)}),o&&a.forEach(({obj:e,callback:t})=>{t(e,this,{x:this.dx,y:this.dy},s)}),this.collision.left=[],this.collision.top=[],this.collision.right=[],this.collision.bottom=[]}}class Spawn extends Block{constructor(e,t,a){super(e,t,a),this.h=2*a.cfg.scale,this.type="Spawn",this.color="brown",this.empty=!0,this.collision=!1,this.id=4,this.purpose=["Special"]}draw(){if("edit"===this.game.mode){const e=this.game.c,t=this.game.cfg.scale,a=this.x*t,l=this.y*t+(t-this.h);e.beginPath(),e.fillStyle=this.color,e.fillRect(a,l,this.w,this.h),e.closePath()}}editUpdate(){this.w=this.game.cfg.scale,this.h=2*this.game.cfg.scale}resolve(e){"Player"!=e.type}}class End extends Block{constructor(e,t,a){super(e,t,a),this.h=2*a.cfg.scale,this.type="End",this.color="cyan",this.empty=!1,this.collision=!0,this.id=5,this.purpose=["Special"]}update(){this.editUpdate()}draw(){const e=this.game,t=e.c,a=e.cfg.scale,l=this.x*a+(a-this.w),i=this.y*a+(a-this.h);t.beginPath(),t.fillStyle=this.color,t.lineWidth=1,t.rect(l,i,this.w+1,this.h+1),t.fill(),t.closePath()}editUpdate(){this.w=this.game.cfg.scale,this.h=2*this.game.cfg.scale}resolve(e){"Player"!=e.type||(this.game.window.play.endTimer(),e.dx=e.dy=0)}}class Wall extends Block{constructor(e,t,a){super(e,t,a),this.type="Wall",this.tile={name:this.game.select.tile.name},this.empty=!1,this.collision=!0,this.id=1,this.purpose=["Static"]}draw(){const e=this.game,t=e.c,a=e.assets.tiles[this.tile.name];t.drawImage(a.img,this.tile.x,this.tile.y,a.size,a.size,this.x*e.cfg.scale,this.y*e.cfg.scale,e.cfg.scale+1,e.cfg.scale+1)}editUpdate(){const e=this.game;if(this.w=e.cfg.scale,this.h=e.cfg.scale,this.tile){this.collision=!!(255>this.tile.value);let t=this.game.utils.tileManager.getID(this.tile.value);this.tile.id=0===t?0:t-1;const a=this.tile.id%e.assets.tiles[this.tile.name].w,l=Math.floor(this.tile.id/e.assets.tiles[this.tile.name].w);this.tile.x=a*e.assets.tiles[this.tile.name].size+a*e.assets.tiles[this.tile.name].iX,this.tile.y=l*e.assets.tiles[this.tile.name].size+l*e.assets.tiles[this.tile.name].iY}}update(){const e=this.game;this.w=e.cfg.scale,this.h=e.cfg.scale}resolve(e,t){"Player"!=e.type||this.normalCollision(e,t)}}class Spikes extends Block{constructor(e,t,a){super(e,t,a),this.h=a.cfg.scale/2,this.type="Spikes",this.color="gray",this.empty=!1,this.collision=!0,this.id=3,this.purpose=["Static"]}update(){this.w=this.game.cfg.scale,this.h=this.game.cfg.scale/2}draw(){const e=this.game,t=e.c,a=e.cfg.scale,l=this.x*a,i=this.y*a+(a-this.h);t.beginPath(),t.drawImage(e.assets.textures.Spikes.img,l,i,this.w+1,this.h+1),t.closePath()}collisionTop(e,t){t.die()}resolve(e,t){"Player"!=e.type||this.normalCollision(e,t)}}class BouncingBox extends Block{constructor(e,t,a){super(e,t,a),this.h=a.cfg.scale/2,this.type="BouncingBox",this.color="purple",this.empty=!1,this.collision=!0,this.id=2,this.purpose=["Static"]}bounceFactor(e){return e.hasBounced?.7:1.1}update(){this.w=this.game.cfg.scale,this.h=this.game.cfg.scale/2}draw(){const e=this.game,t=e.c,a=e.cfg.scale,l=this.x*a,i=this.y*a+(a-this.h);t.beginPath(),t.drawImage(e.assets.textures.BouncingBox.img,l,i,this.w+1,this.h+1),t.closePath()}collisionLeft(e,t){t.dx>MAGNITUDEX?(t.dx*=-e.bounceFactor(t),t.hasBounced=!0):e.stopLeft(e,t)}collisionTop(e,t){t.dy>MAGNITUDEY?(t.dy*=-e.bounceFactor(t),t.isOnFloor=!0,t.hasBounced=!0):e.stopTop(e,t)}collisionRight(e,t){t.dx<-2?(t.dx*=-e.bounceFactor(t),t.hasBounced=!0):e.stopRight(e,t)}collisionBottom(e,t){t.dy<-MAGNITUDEY?(t.dy*=-e.bounceFactor(t),t.hasBounced=!0):e.stopBottom(e,t)}resolve(e,t){"Player"!=e.type||this.normalCollision(e,t)}}class SwordSupport extends Block{constructor(e,t,a){super(e,t,a),this.type="SwordSupport",this.color="gray",this.empty=!1,this.collision=!0,this.id=6,this.purpose=["Static"]}draw(){const e=this.game,t=e.c,a=e.cfg.scale,l=this.x*a+(a-this.w),i=this.y*a+(a-this.h);t.beginPath(),t.fillStyle=this.color,t.lineWidth=1,t.rect(l,i,this.w+1,this.h+1),t.fill(),t.closePath()}resolve(e){"Sword"===e.type}}class Sword extends Block{constructor(e,t,a){super(e,t,a);const l=a.cfg.scale;this.w=l/2,this.h=l/2,this.inX=l/2-this.w/2,this.inY=l/2-this.h/2,this.type="Sword",this.color="yellow",this.empty=!1,this.collision=!0,this.dx=.3,this.id=7,this.purpose=["Dynamic"],this.link="SwordSupport"}getLeft(e){return this.x*this.game.cfg.scale+this.inX+(e?this.dx:0)}getTop(e){return this.y*this.game.cfg.scale+this.inY+(e?this.dx:0)}update(e){const t=this.game,a=t.cfg.scale,l=!(0<this.dx),i=this.inX,n=this.dx;this.w=t.cfg.scale/2,this.h=t.cfg.scale/2,this.inX+=n*e,l&&0>i&&(this.game.dynamic[this.y][this.x]=0,this.x--,this.game.dynamic[this.y][this.x]=this,this.inX+=a),!l&&i>a&&(this.game.dynamic[this.y][this.x]=0,this.x++,this.game.dynamic[this.y][this.x]=this,this.inX-=a)}editUpdate(){const e=this.game,t=e.cfg,a=t.scale;this.inX=a/2-this.w/2,this.inY=a/2-this.h/2,this.w=a/2,this.h=a/2}draw(){const e=this.game.c,t=this.getLeft(),a=this.getTop(),l=this.w,i=this.h;e.beginPath(),e.fillStyle=this.color,e.fillRect(t,a,l,i),e.closePath()}resolve(e){const t=this.game,a=0<this.dx?1:0,l=t.static,i=!(0<this.dx),n=this.dx,o=this.x,c=this.y;switch(e.type){case"SwordSupport":if(l[c][o+a]&&"SwordSupport"===l[c][o+a].type)return;i&&this.getLeft()<e.getLeft()?this.dx=-n:!i&&this.getRight()>e.getRight()&&(this.dx=-n);break;case"Sword":this.dx=-n;break;case"Player":e.die();}}}function Game(e,a,l){var n=this,o=document.getElementById("game");for(let i in this.canvas=document.createElement("canvas"),this.canvas.id="canvas",this.canvas.tabindex=1,this.canvas.innerHTML="You browser is too old to use canvas technologies.",o.appendChild(this.canvas),this.c=this.canvas.getContext("2d"),this.canvas.oncontextmenu=t=>t.preventDefault(),this.canvas.width=innerWidth,this.canvas.height=innerHeight,this.cfg={name:e||"",time:a||null,edited:!1,cols:32,rows:32,scale:64,oldScale:64,updateArr:[[],[],[],[]],updateAll:!1},this.utils={rand:(e,t)=>Math.floor(Math.random()*(t-e+1))+e,loadImg:e=>{let t=new Image;t.src=e.url,e.img=t},lerp:(e,t,a)=>{if(0===e)return!1;a=0>a?0:a,a=1<a?1:a;const l=+(e+(t-e)*a).toFixed(5),i=Math.abs(l-t);return 0==i.toFixed(2)?t:l},getBlock:(e,t,a)=>!!e[a]&&(!e[a]||e[a][t])&&!!e[a][t].collision,events:(e,t)=>{e.listen=()=>{t.forEach(t=>e.game.canvas.addEventListener(t,e,!1))},e.mute=()=>{t.forEach(t=>e.game.canvas.removeEventListener(t,e,!1))},e.handleEvent=t=>{let a=`on${t.type}`;if("function"==typeof e[a])return t.preventDefault(),e[a](t)}},textSize:(e,t)=>[e.measureText(t).width,.7*parseInt(e.font.match(/\d+/),10)],mouseCollision:(e,t)=>{const a=e.x,l=a+e.w,i=e.y,n=i+e.h,o=t.x,c=t.y;return!!(a<=o&&l>=o&&i<=c&&n>=c)},catchBlockCollision:(e,t)=>{let a=!1;return["static","dynamic"].forEach(l=>{const i=n[l];return!!(i[t]&&i[t][e]&&i[t][e].collision&&"SwordSupport"!==i[t][e].type)&&void(a=i[t][e])}),a},numberToClass:(e,t)=>0===t?e.Objects.Block:1===t?e.Objects.Wall:2===t?e.Objects.BouncingBox:3===t?e.Objects.Spikes:4===t?e.Objects.Spawn:5==t&&e.Objects.End,load:(e,t)=>{const a=new XMLHttpRequest;a.open("GET",e,!1),a.send(null),t.innerHTML=a.responseText},handleError:()=>{},tileManager:{getID:e=>{return{0:1,2:2,8:3,10:4,11:5,16:6,18:7,22:8,24:9,26:10,27:11,30:12,31:13,64:14,66:15,72:16,74:17,75:18,80:19,82:20,86:21,88:22,90:23,91:24,94:25,95:26,104:27,106:28,107:29,120:30,122:31,123:32,126:33,127:34,208:35,210:36,214:37,216:38,218:39,219:40,222:41,223:42,248:43,250:44,251:45,254:46,255:47}[e]},getValue(e,t,a,l=!1,i=!1){function n(t,a,l,n,g=!1){(!o[a]||o[a]&&!o[a][t])&&c[a]&&c[a][t]&&"1"!=c[a][t][1]||o[a]&&o[a][t]&&"Wall"!=o[a][t].type||o[a]&&o[a][t]&&o[a][t].empty||(s+=l,0<=n&&(r[n]=!0),!i&&o[a]&&o[a][t]&&(e.utils.tileManager.getValue(e,t,a,!1,!0),d.push({x:t,y:a})))}const o=e.static,c=e.map;let s=0,d=[];const r=[!1,!1,!1,!1];return n(t,a-1,2,0),n(t,a+1,64,1,!0),n(t-1,a,8,2),n(t+1,a,16,3),r[0]&&r[2]&&n(t-1,a-1,1),r[0]&&r[3]&&n(t+1,a-1,4),r[1]&&r[2]&&n(t-1,a+1,32),r[1]&&r[3]&&n(t+1,a+1,128),l||(o[a][t].tile.value=s),o[a][t]&&o[a][t].editUpdate(),d}}},this.map=l||"0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###",this.firstInit=!0,this.background=[],this.static=[],this.dynamic=[],this.foreground=[],this.lastRender=null,this.now=null,this.resetAnimate=!0,this.Player=new Player(5,5,"Player1",this),this.Objects={Block:[Block,0,["background"]],Wall:[Wall,1,["static"]],BouncingBox:[BouncingBox,2,["static"]],Spikes:[Spikes,3,["static"]],Spawn:[Spawn,4,["special"]],End:[End,5,["special"]],SwordSupport:[SwordSupport,6,["static"]],Sword:[Sword,7,["dynamic"],"SwordSupport"]},this.editObjects=Object.values(this.Objects).filter(e=>"number"==typeof e[1]),this.mode="edit",this.Engine=new Engine(this.c,this.cfg.cols,this.cfg.rows,this.cfg.scale),this.Camera=new Camera(n),this.assets={tiles:{spaceGround:{name:"spaceGround",w:8,h:6,l:47,iX:10,iY:10,size:64,url:"./img/space-tileMap.png",img:null}},textures:{Spikes:{name:"Spikes",url:"./img/spikes.png",img:null},BouncingBox:{name:"BouncingBox",url:"./img/bouncingBox.png",img:null}}},this.translate={x:0,y:0},this.playing=[!1,!1],this.select={color:"blue",brushSize:0,block:null,tile:n.assets.tiles.spaceGround,layer:null},this.mouse={x:null,y:null,gridX:0,gridY:0,left:!1,right:!1,click:null,middle:{click:!1,x:null,y:null},last:{gridX:void 0,gridY:void 0,click:"nop"}},this.window={play:new PlayWindow(this),edit:new EditWindow(this)},this.mapInit={load:function(){var e=n;if(e.firstInit){let t=e.map.split(",");t.map((e,a)=>{t[a]=e.split("-"),t[a].map((e,l)=>{t[a][l]=e.split("")})}),e.map=t,e.cfg.cols=t[0].length,e.cfg.rows=t.length,e.firstInit=!1}for(let t=0;t<e.map.length;t++)for(let a=0;a<e.map[0].length;a++){const l=e.map[t][a],i=["background","static","dynamic","foreground"];l.forEach((l,o)=>{const c=e[i[o]];if(c[t]||(c[t]=[]),"#"===l)return c[t][a]=0;const s=e.editObjects.find(e=>e[1]==l);switch(l.toString()){case"1":c[t][a]=new s[0](a,t,e),n.utils.tileManager.getValue(e,a,t,!1,!1);break;case"4":e.Player.respawn=[a,t-1],c[t][a]=new s[0](a,t,e),e[i[0]][t][a]=new e.Objects.Block[0](a,t,e);break;default:c[t][a]=new s[0](a,t,e);}})}},save:function(){var e=n,t=[];["background","static","dynamic","foreground"].forEach((a,l)=>{const i=e[a];i.forEach((e,a)=>{t[a]||(t[a]=[]),e.forEach((e,i)=>{t[a][i]||(t[a][i]=[]),t[a][i][l]=e?e.id:"#"})})}),e.map=t,e.cfg.cols=t[0].length,e.cfg.rows=t.length}},n.assets.tiles)n.utils.loadImg(n.assets.tiles[i]);for(let t in n.assets.textures)n.utils.loadImg(n.assets.textures[t]);this.init=function(e=!1){e&&this.mapInit.save(this),this.mapInit.load(this),this.Player.init(),this.Camera=new Camera(this),console.log("Lets go !")};let c=0,s=0;const d=()=>{c++,n.c.beginPath(),n.c.fillStyle="rgba(0, 0, 0, 0.5)",n.c.fillRect(n.canvas.width-80,0,100,40),n.c.fillStyle="white",n.c.font="11px Arial",n.c.fillText(`ZOOM: x${(n.cfg.scale/64).toFixed(2)}`,n.canvas.width-75,15),n.c.fillText(`FPS: ${s}`,n.canvas.width-75,30),n.c.rect(0,0,n.canvas.width,n.canvas.height),n.c.stroke(),n.c.closePath()},r=setInterval(()=>{s=c,c=0},1e3);let g;var p=null;this.animate=function(e){e||(e=0);const t=e;n.resetAnimate&&(g=e),this.dt=t-g,100<this.dt&&(this.dt=100),"play"===n.mode?(n.window.play.update(this.dt),n.window.play.draw()):"edit"===n.mode&&n.window.edit.update(),d(),g=e,n.resetAnimate&&(n.resetAnimate=!1),n.playing[0]&&(p=window.requestAnimationFrame(n.animate))},this.play=()=>{var e=document.getElementById("mapList"),t=document.getElementById("game");e.style.display="none",t.style.display="block",this.mode="play",this.init(),this.playing=[!0,!0],this.cfg.updateAll=!0,this.resetAnimate=!0,this.window.play.start(),this.animate()},this.edit=()=>{var e=document.getElementById("mapList"),t=document.getElementById("game");e.style.display="none",t.style.display="block",this.mode="edit",this.init(),this.playing=[!0,!0],this.cfg.updateAll=!0,this.window.edit.start(),this.animate()},this.end=()=>{for(el in this.window[this.mode].end(),window.cancelAnimationFrame(p),this.canvas.parentNode.removeChild(this.canvas),this)delete this[el];var e=document.getElementById("mapList"),t=document.getElementById("game");e.style.display="block",t.style.display="none"}}function gameMenu(t){const a=document.head||document.getElementsByTagName("head")[0],l=document.createElement("style");a.appendChild(l),l.type="text/css",l.id="stylePlay",l.styleSheet?l.styleSheet.cssText="#playMenu {\n position:absolute;\n width:0;\n top:0;\n bottom:0;\n left:0;\n background:rgba(15,15,15,0.99);\n text-align:center;\n overflow:hidden;\n padding-top:36vh;\n padding-top:calc(50vh - (7vh*2+10));\n}\n .playBtn {\n display:block;\n width:20vw;\n height:7vh;\n background:black;\n color:white;\n margin:0 auto 10px auto;\n}\n #timer {\n display:inline-block;\n margin:0;\n position:absolute;\n text-align:center;\n top:0;\n left:0;\n width:100%;\n padding:10px 0;\n color:white;\n font-size:2.3em;\n font-weight:bold;\n z-index:1000;\n}\n #timer > span {\n padding:10px 20px;\n background:rgba(0,0,0,0.7);\n}\n":l.appendChild(document.createTextNode("\n #playMenu {\n position:absolute;\n width:0;\n top:0;\n bottom:0;\n left:0;\n background:rgba(15,15,15,0.99);\n text-align:center;\n overflow:hidden;\n padding-top:36vh;\n padding-top:calc(50vh - (7vh*2+10));\n}\n .playBtn {\n display:block;\n width:20vw;\n height:7vh;\n background:black;\n color:white;\n margin:0 auto 10px auto;\n}\n #timer {\n display:inline-block;\n margin:0;\n position:absolute;\n text-align:center;\n top:0;\n left:0;\n width:100%;\n padding:10px 0;\n color:white;\n font-size:2.3em;\n font-weight:bold;\n z-index:1000;\n}\n #timer > span {\n padding:10px 20px;\n background:rgba(0,0,0,0.7);\n}\n"));const i=document.getElementById("game"),n=document.getElementById("canvas"),o=document.createElement("p");o.id="timer";const c=document.createElement("span");c.innerHTML="00:00:00",o.appendChild(c),i.appendChild(o);const s=document.createElement("div");s.id="playMenu";const d=document.createElement("input");d.id="btnResume",d.type="button",d.classList.add("playBtn"),d.value="RESUME",d.onclick=a=>{a.preventDefault(),t.window.play.pauseTimer(),s.style.width=0},s.append(d);const r=document.createElement("input");r.id="btnRestart",r.type="button",r.classList.add("playBtn"),r.value="RESTART",r.onclick=a=>{a.preventDefault(),t.window.play.gameReset()},s.append(r);const g=document.createElement("input");return g.id="btnEdit",g.type="button",g.classList.add("playBtn"),g.value="EDIT MAP",g.onclick=a=>{a.preventDefault(),t.window.play.end(),t.mode="edit",t.window.edit.start(),t.init(),t.playing=[!0,!0],t.cfg.updateAll=!0,t.canvas.focus(),t.animate(),t.cfg.edited=!0},s.append(g),s}function toolbar(t){function a(){k.innerHTML="Block Type: ";const e=document.createElement("select");e.id="selectBlock";const a=l("Spawn",t.static),n=l("End",t.static);let o=document.createElement("option");e.appendChild(o);for(var c=0;c<t.editObjects.length;c++){const l=t.editObjects[c],i=t.select.layer;l[2]==i&&(o=document.createElement("option"),o.value=l[0].name,o.text=l[0].name,4===l[1]&&a?o.disabled=!0:5===l[1]&&n&&(o.disabled=!0),e.appendChild(o))}e.style.display="block",e.onchange=a=>{const e=a.target.selectedIndex,l=a.target[e].value;t.select.block=t.Objects[l]},k.appendChild(e)}function l(e,t){for(let a=0;a<t.length;a++)if(t[a].some(t=>t.type===e))return!0}const n=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style"),c=`#toolbar {\n position:absolute;\n top:0;\n bottom:0;\n left:0;\n background:rgba(15,15,15, 1);\n overflow:hidden;\n text-align:center;\n padding-top:20vh;\n }\n #toolbar > * {\n margin:20px auto;\n }\n .dispBlock {\n display:block;\n }\n #playH2 {\n margin-bottom:30px;\n }\n #btnHide {\n position:absolute;\n padding:${t.canvas.height/2-20}px 7px;\n height:100%;\n top:0;\n right:0;\n background:black;\n color:white;\n margin:0 auto;\n text-decoration:none;\n }\n .inputSpan > input {\n width:15%;\n }\n #selectSpan > * {\n display:block;\n margin:auto;\n }\n .playBtn {\n border:1px solid white;\n padding:10px 20px;\n background:black;\n font-weight:bold;\n color:white;\n margin:auto 5px !important;\n cursor:pointer;\n }\n #errorMsg {\n color:red;\n font-size:1.1em;\n }\n`;n.appendChild(o),o.type="text/css",o.id="styleEdit",o.styleSheet?o.styleSheet.cssText=c:o.appendChild(document.createTextNode(c));const s=document.createElement("div");s.id="toolbar",s.style.width="25%";const d=document.createElement("a");d.id="btnHide",d.innerHTML="|||",d.href="",d.onclick=t=>{t.preventDefault();const e=s.style.width.replace(/px|%/i,"");s.style.width=20<e?20:"25%"},s.appendChild(d);const r=document.createElement("h2");r.innerHTML="SETTINGS:",r.id="playH2",s.appendChild(r);const e=document.createElement("span");e.innerHTML="Name: ",e.classList.add("dispBlock","inputSpan");const g=document.createElement("input");g.type="text",g.value=t.cfg.name,g.onchange=function(a){t.cfg.name=a.target.value},e.appendChild(g),s.appendChild(e);const p=["background","static","dynamic","foreground"],m=document.createElement("span");m.innerHTML="Row: ",m.classList.add("dispBlock","inputSpan");const y=document.createElement("input");y.type="number",y.value=t.cfg.rows,y.onchange=function(a){const e=a.target.value,l=[];p.forEach(a=>{const i=t[a];for(let n=0;n<e;n++)if(i[n])l[n]=i[n];else{l[n]=[];for(let e=0;e<t.cfg.cols;e++)l[n][e]="background"===a?new t.Objects.Block[0](e,n,t):0}t[a]=l}),t.cfg.rows=+e,t.cfg.updateAll=!0,t.translate.x=t.translate.y=0},m.appendChild(y),s.appendChild(m);const h=document.createElement("span");h.innerHTML="Col: ",h.classList.add("dispBlock","inputSpan");const u=document.createElement("input");u.type="number",u.value=t.cfg.cols,u.onchange=function(a){const e=a.target.value;p.forEach(a=>{const l=t[a];let n=[];for(let o=0;o<t.cfg.rows;o++){n[o]=[];for(let c=0;c<e;c++)n[o][c]=l[o][c]?l[o][c]:"background"===a?new t.Objects.Block[0](c,o,t):0}t[a]=n}),t.cfg.cols=+e,t.cfg.updateAll=!0,t.translate.x=t.translate.y=0},h.appendChild(u),s.appendChild(h);const f=["background","static","dynamic","foreground","special"],w=document.createElement("select");w.id="layerBlock";for(var x=0;x<f.length;x++){const e=document.createElement("option");e.value=f[x],e.text=f[x],w.appendChild(e)}w.value="static",t.select.layer="static",w.style.display="block",w.onchange=a=>{const e=a.target.selectedIndex,l=a.target[e].value;t.select.layer=l,document.dispatchEvent(refreshBlockType)};const b=document.createElement("span");b.innerHTML="Layer ",b.classList.add("dispBlock"),b.id="selectSpan",b.appendChild(w),s.appendChild(b);const k=document.createElement("span");k.classList.add("dispBlock"),k.id="selectSpan",s.appendChild(k),window.refreshBlockType=new Event("refreshBlockType"),document.addEventListener("refreshBlockType",a,!1),document.dispatchEvent(refreshBlockType);const v=document.createElement("input");v.type="text";const E=document.createElement("input");E.type="button",E.value="Play",E.classList.add("playBtn"),E.onclick=()=>{const e=l("Spawn",t.static),a=l("End",t.static);return e&&a?void(t.window[t.mode].end(),t.mode="play",t.init(!0),t.cfg.updateAll=!0,t.canvas.focus(),t.window.play.resetTimer(),t.Player.hide=!1,!t.playing[0]&&(t.playing[0]=!0,t.resetAnimate=!0,t.animate()),t.window.play.start()):T.innerHTML=`You can't play without ${e?"End":"Spawn"} block !`},s.appendChild(E);const B=document.createElement("input");B.type="button",B.value="Save",B.classList.add("playBtn"),B.onclick=()=>{if(!t.cfg.name)return T.innerHTML=`You forgot to set the name !`;const e=l("Spawn",t.static),a=l("End",t.static);if(!e||!a)return T.innerHTML=`You can't save without ${e?"End":"Spawn"} block !`;let i="";var n=t.static,o=n[0].length,c=n.length;for(let e=0;e<n.length;e++){for(let a=0;a<n[0].length;a++)p.forEach(l=>{const n=t[l];i+=n[e][a]?n[e][a].id:"#"}),i+=a+1<n[0].length?"-":"";i+=e+1<n.length?",":""}var s=new XMLHttpRequest;s.onloadend=()=>{},s.open("POST","/saveMap",!0),s.setRequestHeader("Content-type","application/json"),s.send(JSON.stringify({name:t.cfg.name,cols:o,rows:c,data:i}))},s.appendChild(B);const T=document.createElement("span");return T.classList.add("dispBlock"),T.id="errorMsg",s.appendChild(T),s}