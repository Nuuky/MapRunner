var GRAVITY=.0035,JUMPFORCE=1,MAXSPEED=.6,ACCEL=.2,MAGNITUDEX=2,MAGNITUDEY=.2;class Engine{constructor(t,e,s,i){this.c=t,this.cols=e,this.rows=s,this.cells=[]}create(t,e,s){this.rows=t,this.cols=e,this.scale=s,this.clear();for(let t=0;t<this.rows;t++){this.cells[t]=[];for(let e=0;e<this.cols;e++)this.cells[t][e]=[]}}clear(){this.cells=[]}insert(t){const e=t.getLeft(!0),s=t.getTop(!0),i=t.getRight(!0),n=t.getBottom(!0),a=this.scale,l=Math.floor(e/a),o=Math.ceil(i/a),h=Math.floor(s/a),c=Math.ceil(n/a);for(let e=h;e<c;e++)for(let s=l;s<o;s++)this.makeCell(e,s)&&this.cells[e][s].push(t)}makeCell(t,e){const s=this.cells;return!!s[t]&&(s[t][e]||(this.cells[t][e]=[]),!0)}isColliding(t,e){const s=t.getLeft(!0),i=t.getRight(!0),n=t.getTop(!0),a=t.getBottom(!0),l=e.getLeft(!0),o=e.getRight(!0),h=e.getTop(!0),c=e.getBottom(!0);return s<o&&i>l&&n<c&&a>h}checkCells(){this.cells.forEach(t=>{t.forEach(t=>{!t||t.length<=1||this.testCellEntities(t)})})}testCellEntities(t){const e=t.length;t.forEach((s,i)=>{for(let n=i+1;n<e;n++){const e=t[n];this.isColliding(s,e)&&s!==e&&this.resolve(s,e)}})}resolve(t,e){let s=t.dx,i=t.dy,n=e.dx,a=e.dy,l=1;(Math.abs(t.dx)>16||Math.abs(t.dy)>16||Math.abs(e.dx)>16||Math.abs(e.dy)>16)&&(l=10);for(let o=1;o<=l;o++){s=t.dx/l*o,i=t.dy/l*o,n=e.dx/l*o,a=e.dy/l*o;const h=.5*(t.w+e.w),c=.5*(t.h+e.h),r=t.getHalfWidth()+s-(e.getHalfWidth()+n),d=t.getHalfHeight()+i-(e.getHalfHeight()+a);if(Math.abs(r)<=h&&Math.abs(d)<=c){const s=h*d,i=c*r;if(s>i){s>-i?(t.resolve(e,"TOP"),e.resolve(t,"BOTTOM")):(t.resolve(e,"RIGHT"),e.resolve(t,"LEFT"));break}s>-i?(t.resolve(e,"LEFT"),e.resolve(t,"RIGHT")):(t.resolve(e,"BOTTOM"),e.resolve(t,"TOP"));break}}}oldResolve(t,e){const s=t.getHalfWidth(!0)-e.getHalfWidth(!0),i=t.getHalfHeight(!0)-e.getHalfHeight(!0),n=t.w/2+e.w/2,a=t.h/2+e.h/2;let l="",o=s<0&&i<0;if(Math.abs(s)<n&&Math.abs(i)<a){var h=n-Math.abs(s),c=a-Math.abs(i);h>c?l=i>0?0:1:h<c?l=s>0?2:3:o||s!==i?!o&&s<i?l=0:!o&&s>i?l=1:o&&s===i&&(l=1):l=0}t.resolve(e,["TOP","BOTTOM","LEFT","RIGHT","TOP_LEFT","TOP_RIGHT","BOTTOM_LEFT","BOTTOM_RIGHT"][l]),e.resolve(t,["BOTTOM","TOP","RIGHT","LEFT","BOTTOM_RIGHT","BOTTOM_LEFT","TOP_RIGHT","TOP_LEFT"][l])}}class Camera{constructor(t){this.game=t,this.x=0,this.y=0,this.oldX=0,this.oldY=0}update(){const t=this.game,e=t.canvas,s=t.Player,i=t.cfg.scale,n=t.cfg.cols*i,a=t.cfg.rows*i,l=n-e.width,o=a-e.height,h=e.width<n,c=e.height<a,r=s.camX+s.w/2,d=s.camY+s.h/2;let g=-r+e.width/2,m=-d+e.height/2;h||(g=e.width/2-n/2),c||(m=e.height/2-a/2),h&&r<=e.width/2?g=0:h&&r>=n-e.width/2&&(g=-l),c&&d<=e.height/2?m=0:c&&d>=a-e.height/2&&(m=-o),s.isDead?t.translate.x==g&&t.translate.y==m?s.spawn():(t.translate.x=t.utils.lerp(t.translate.x,g,.2),t.translate.y=t.utils.lerp(t.translate.y,m,.2),this.x=t.translate.x,this.y=t.translate.y):(t.translate.x=g,t.translate.y=m,this.x=t.translate.x,this.y=t.translate.y),this.oldX=this.x,this.oldY=this.y}}class Button{constructor(t,e,s,i,n,a,l,o,h,c=!1){this.x=e,this.y=s,this.halfX=e,this.halfY=s,this.fontSize=a,this.str=l,this.game=t,this.w=i,this.h=n,this.offX=0,this.offY=0,this.backColor="black",this.fontColor="white",this.cb=h,this.autoDestroy=c,this.onOver=(t=>{this.game.utils.mouseCollision(this,{x:t.clientX,y:t.clientY})?(this.backColor="brown",this.draw()):(this.backColor="black",this.draw())}),this.click=(t=>{this.game.utils.mouseCollision(this,{x:t.clientX,y:t.clientY})&&(this.cb(),c&&this.destroy())}),document.addEventListener("mousemove",this.onOver),document.addEventListener("click",this.click),this.draw()}draw(){const t=this.game,e=(t.canvas,t.c);e.font=`${this.fontSize}pt Tahoma`;const s=t.utils.textSize(e,this.str);this.offX=this.w-s[0],this.offY=this.h-s[1],this.x=this.halfX-(s[0]+this.offX)/2,this.y=this.halfY-(s[1]+this.offY)/2,e.beginPath(),e.fillStyle=this.backColor,e.strokeStyle=this.fontColor,e.lineWidth=3,e.rect(this.x,this.y,s[0]+this.offX,s[1]+this.offY),e.fill(),e.stroke(),e.closePath(),e.beginPath(),e.fillStyle=this.fontColor,e.fillText(this.str,this.halfX-s[0]/2,this.halfY+s[1]/2),e.closePath()}getLeft(){return this.halfX}getTop(){return this.halfY}getRight(){return this.getLeft()+this.w}getBottom(){return this.getTop()+this.h}destroy(){document.removeEventListener("mousemove",this.onOver),document.removeEventListener("click",this.click)}}class PlayWindow{constructor(t){this.game=t,this.list="ontouchstart"in window?["touchstart","touchmove","touchend"]:["mousedown","mousemove","mouseup","keyup","keydown"],this.startTime=0,this.endTime=0,this.pauseStart=0,this.timer=0}update(t){const e=this.game;if(!e.playing[1])return;this.dt=t;const s=e.cfg,i=s.scale,n=e.canvas,a=e.translate.x,l=e.translate.y,o=e.Player,h=e.Engine,c=e.map,r=c[0].length,d=c.length,g=n.width,m=n.height;h.create(s.rows,s.cols,i),o.isDead||o.hide||(o.move(t),h.insert(o));const u=Math.floor(a/i*-1)-20>0?Math.floor(a/i*-1)-20:0,p=Math.floor(l/i*-1)-20>0?Math.floor(l/i*-1)-20:0,y=Math.ceil(g/i)+u+40>r?r:Math.ceil(g/i)+u+40,f=Math.ceil(m/i)+p+40>p?d:Math.ceil(m/i)+p+40;["static","dynamic"].map(s=>{const i=e[s];for(let e=p;e<f;e++)for(let s=u;s<y;s++){if(!i[e]||!i[e][s])continue;const n=i[e][s];!n.empty&&n.collision&&(n.update(t),h.insert(n))}}),h.checkCells(),o.update(t),this.timer=Date.now()-this.startTime}draw(){const t=this.game;if(!t.playing[1])return;const e=t.cfg.scale,s=t.canvas,i=t.translate.x,n=t.translate.y,a=t.Player,l=t.map,o=t.c,h=l[0].length,c=l.length,r=s.width,d=s.height;o.clearRect(0,0,s.width,s.height),t.Camera.update(),o.save(),o.translate(i,n);const g=Math.floor(i/e*-1)-1>0?Math.floor(i/e*-1)-1:0,m=Math.floor(n/e*-1)-1>0?Math.floor(n/e*-1)-1:0,u=Math.ceil(r/e)+g+2>h?h:Math.ceil(r/e)+g+2,p=Math.ceil(d/e)+m+2>m?c:Math.ceil(d/e)+m+2;["background","static","dynamic","foreground"].map(e=>{const s=t[e];"dynamic"===e&&a.draw();for(let t=m;t<p;t++)for(let e=g;e<u;e++){if(!s[t]||s[t]&&!s[t][e])continue;const i=s[t][e];i.empty||(i.collision||i.update(),i.draw())}}),o.restore(),this.displayTimer()}startTimer(){this.startTime=Date.now(),this.game.Player.hide=!1}pauseTimer(){this.game.playing[0]?(this.pauseStart=Date.now(),this.game.playing[0]=!1,console.log("Pause")):(this.startTime&&(this.startTime-=this.pauseStart-Date.now()),this.game.playing[0]=!0,this.game.resetAnimate=!0,this.game.animate(),console.log("Play")),this.game.canvas.focus()}resetTimer(){this.startTime=0,this.endTime=0,this.pauseStart=0}endTimer(){if(this.endTime=Date.now()-this.startTime,this.game.Player.hide=!0,console.log(getTime(this.endTime)),console.log(this.game.cfg),!(null!=this.game.cfg.time&&this.endTime>=this.game.cfg.time||this.game.cfg.edited)){var t=new XMLHttpRequest;t.open("POST","/scoreMap",!0),t.setRequestHeader("Content-type","application/json"),t.send(JSON.stringify({name:this.game.cfg.name,time:this.endTime}))}}displayTimer(){const t=this.game;t.canvas,t.c;let e=this.endTime>0?this.endTime:this.timer;0===this.startTime&&(e=0);const s=getTime(e),i=document.getElementById("timer");i&&(i.children[0].innerHTML=s)}start(){console.log("Start window Play"),this.list.forEach(t=>document.addEventListener(t,this,!1));const t=document.getElementById("game"),e=gameMenu(this.game);t.insertBefore(e,this.game.canvas)}end(){console.log("End window Play"),this.list.forEach(t=>document.removeEventListener(t,this,!1));const t=document.getElementById("playMenu"),e=document.getElementById("stylePlay"),s=document.getElementById("timer");t.parentNode.removeChild(t),s.parentNode.removeChild(s),e.parentNode.removeChild(e),this.resetTimer()}gameReset(){const t=this.game;t.init(),t.playing[0]||(t.playing[0]=!0,t.animate()),t.canvas.focus(),this.resetTimer(),t.Player.hide=!1,t.Player.dx=0,t.Player.dy=0}handleEvent(t){let e=`on${t.type}`;if("function"==typeof this[e])return t.preventDefault(),this[e](t)}onkeydown(t){const e=this.game;if(t.preventDefault(),e.playing[0]){if(e.Player.keys.hasOwnProperty(t.keyCode)&&(e.Player.keys[t.keyCode]=!0),27==t.keyCode){const t=document.getElementById("playMenu");this.pauseTimer();const s=t.style.width.replace(/[px%]/i,"");t.style.width=s>0?0:"100%",e.canvas.focus()}82==t.keyCode&&this.gameReset()}}onkeyup(t){const e=this.game;t.preventDefault(),e.playing[0]&&e.Player.keys.hasOwnProperty(t.keyCode)&&(e.Player.keys[t.keyCode]=!1)}onmousedown(t){}onmouseup(t){}onmousemove(t){}onmouseleave(t){const e=this.game;e.playing[0]&&(e.mouse.left=!1,e.mouse.right=!1,e.mouse.middle={click:!1,x:null,y:null})}ontouchstart(t){this.game,t.targetTouches.item(0)}ontouchmove(t){this.game,t.targetTouches.item(0)}ontouchend(t){this.game}}class EditWindow{constructor(t){this.game=t,this.list=["mousedown","mousemove","mouseup","wheel","mouseleave","keyup","keydown"]}update(){const t=this.game;if(!t.playing[1])return;const e=t.cfg.scale,s=t.canvas,i=t.translate.x,n=t.translate.y,a=t.c,l=t.cfg.updateAll,o=t.cfg.updateArr;l&&a.clearRect(0,0,s.width,s.height),a.save(),a.translate(i,n);const h=["background","static","dynamic","foreground"];if(l){const a=Math.ceil(s.width/e),l=Math.ceil(s.height/e),o=Math.floor(i/e*-1)>0?Math.floor(i/e*-1):0,c=Math.floor(n/e*-1)>0?Math.floor(n/e*-1):0;for(let e=c;e<l+c+1;e++)for(let s=o;s<a+o+1;s++)h.forEach(i=>{const n=t[i];if(!n[e])return;if(!n[e][s])return;const a=n[e][s];a.editUpdate(),a.draw()});t.cfg.updateAll=!1}else o.length>0&&(o.forEach(e=>{h.forEach(s=>{const i=t[s];if(!i[e.y]||!i[e.y][e.x])return;const n=i[e.y][e.x];n.editUpdate(),n.draw()})}),t.cfg.updateArr=[]);a.restore()}start(){console.log("Start window Edit");const t=document.getElementById("game"),e=toolbar(this.game);t.insertBefore(e,this.game.canvas),this.list.forEach(t=>this.game.canvas.addEventListener(t,this,!1))}end(){this.game.cfg.scale=64,console.log("End window Edit"),this.list.forEach(t=>this.game.canvas.removeEventListener(t,this,!1));const t=document.getElementById("toolbar"),e=document.getElementById("styleEdit");t.parentNode.removeChild(t),e.parentNode.removeChild(e)}handleEvent(t){let e=`on${t.type}`;if("function"==typeof this[e])return t.preventDefault(),this[e](t)}onkeydown(t){const e=this.game;e.playing[0]&&70===t.keyCode&&(e.mouse.middle={click:!0,x:e.mouse.x,y:e.mouse.y})}onkeyup(t){const e=this.game;e.playing[0]&&70===t.keyCode&&(e.mouse.middle={click:!1,x:null,y:null})}onmousedown(t){const e=this.game;if(e.playing[0]){switch(t.button){case 0:e.mouse.click="left",e.mouse.left=!0;break;case 1:e.mouse.click="middle",e.mouse.middle={click:!0,x:e.mouse.x,y:e.mouse.y};break;case 2:e.mouse.click="right",e.mouse.right=!0}this.checkForClicks()}}onmouseup(t){const e=this.game;if(e.playing[0])switch(e.mouse.click=null,t.button){case 0:e.mouse.left=!1;break;case 1:e.mouse.middle={click:!1,x:null,y:null};break;case 2:e.mouse.right=!1}}onwheel(t){const e=this.game;if(t.preventDefault(),!e.playing[0])return;const s=e.mouse,i=e.translate.x,n=e.translate.y,a=e.cfg.scale,l=t.wheelDelta>0?4:-4;8<=a+l&&a+l<=96&&(e.translate.x=s.x-(s.x-i)/a*(a+l),e.translate.y=s.y-(s.y-n)/a*(a+l),e.cfg.oldScale=e.cfg.scale,e.cfg.scale+=l,e.cfg.updateAll=!0)}onmousemove(t){const e=this.game;if(!e.playing[0])return;const s=e.mouse,i=e.cfg.scale,n=e.translate.x,a=e.translate.y;e.mouse.x=t.clientX,e.mouse.y=t.clientY,e.mouse.gridX=Math.floor((s.x-n)/i),e.mouse.gridY=Math.floor((s.y-a)/i),(s.left||s.right||s.middle.click)&&(s.middle.click&&this.checkForClicks(),s.gridX===s.last.gridX&&s.gridY===s.last.gridY&&s.click===s.last.click||this.checkForClicks())}onmouseleave(t){const e=this.game;e.playing[0]&&(e.mouse.left=!1,e.mouse.right=!1,e.mouse.middle={click:!1,x:null,y:null})}ontouchstart(t){this.game,t.targetTouches.item(0)}ontouchmove(t){this.game,t.targetTouches.item(0)}ontouchend(t){this.game}checkForClicks(){const t=this.game,e=t.mouse.gridX,s=t.mouse.gridY,i=t.mouse,n=t.cfg;document.getElementById("selectBlock");let a=["background","static","dynamic","foreground","special"],l=a.indexOf(t.select.layer);4===l&&(l=1);const o=t[a[l]];if(!o[s]||!o[s][e]&&0!=o[s][e])return;o[s][e];const h=i.x,c=i.y;i.last.gridX=e,i.last.gridY=s;const r=()=>{if(t.select.block){if(t.select.block[3]){let i=!1;if((a=["background","static","dynamic","foreground"]).forEach(n=>{const a=t[n][s][e];t.select.block[3]===a.type&&(i=!0)}),!i)return t.utils.handleError(t.select.block[1],"link")}1===t.select.block[1]?(o[s][e]=new t.select.block[0](e,s,t),n.updateArr.push(...this.game.utils.tileManager.getValue(t,e,s,!1,!1)),n.updateArr.push({x:e,y:s})):4===t.select.block[1]||5===t.select.block[1]?("Wall"===o[s-1][e].type?(o[s-1][e]=new t.Objects.Block[0](e,s-1,t),n.updateArr.push(...this.game.utils.tileManager.getValue(t,e,s-1,!0,!1))):o[s-1][e]=new t.Objects.Block[0](e,s-1,t),"Wall"===o[s][e].type?(o[s][e]=new t.select.block[0](e,s,t),n.updateArr.push(...this.game.utils.tileManager.getValue(t,e,s,!0,!1))):o[s][e]=new t.select.block[0](e,s,t),4===t.select.block[1]&&(t.Player.respawn=[e,s-1]),n.updateArr.push({x:e,y:s-1},{x:e,y:s}),document.dispatchEvent(refreshBlockType)):("Wall"===o[s][e].type?(o[s][e]=new t.select.block[0](e,s,t),n.updateArr.push(...this.game.utils.tileManager.getValue(t,e,s,!0,!1))):o[s][e]=new t.select.block[0](e,s,t),n.updateArr.push({x:e,y:s}))}};if(i.right){if(!o[s][e])return;i.last.click="right","background"!=a[l]&&(t.background[s][e]=new t.Objects.Block[0](e,s,t)),o[s][e]=0,n.updateArr.push(...this.game.utils.tileManager.getValue(t,e,s,!0,!1)),n.updateArr.push({x:e,y:s}),document.dispatchEvent(refreshBlockType)}i.left&&(i.last.click="left",r()),i.middle.click&&(i.last.click="middle",t.translate.x+=h-i.middle.x,t.translate.y+=c-i.middle.y,i.middle.x=h,i.middle.y=c,n.updateAll=!0)}}class Block{constructor(t,e,s){this.type="Block",this.game=s,this.x=t,this.y=e,this.w=s.cfg.scale,this.h=s.cfg.scale,this.dx=0,this.dy=0,this.color="#111115",this.empty=!1,this.collision=!1,this.id=0,this.purpose=["Background"],this.link=!1}getLeft(t){const e=this.game.cfg.scale;return this.x*e+(e-this.w)+(t?this.dx:0)}getTop(t){const e=this.game.cfg.scale;return this.y*e+(e-this.h)+(t?this.dy:0)}getRight(t){return this.getLeft(t)+this.w}getBottom(t){return this.getTop(t)+this.h}getHalfWidth(t){return this.getRight(t)-this.w/2}getHalfHeight(t){return this.getBottom(t)-this.h/2}draw(){const t=this.game,e=t.c,s=t.cfg.scale,i=this.x*s+(s-this.w),n=this.y*s+(s-this.h);e.beginPath(),e.fillStyle=this.color,e.rect(i,n,this.w,this.h),e.fill(),"edit"===this.game.mode&&(e.strokeStyle="gray",e.stroke()),e.closePath()}update(){const t=this.game.cfg.scale;this.w=t,this.h=t}editUpdate(){this.update()}collisionLeft(t,e,s,i){t.stopLeft(t,e)}collisionTop(t,e,s,i){t.stopTop(t,e)}collisionRight(t,e,s,i){t.stopRight(t,e)}collisionBottom(t,e,s,i){t.stopBottom(t,e)}stopLeft(t,e){e.x=t.getLeft()-e.w,e.dx=0}stopTop(t,e){e.y=t.getTop()-e.h,e.dy=0,e.hasBounced=!1,e.isOnFloor=!0}stopRight(t,e){e.x=t.getRight(),e.dx=0}stopBottom(t,e){e.y=t.getBottom(),e.dy=0}normalCollision(t,e){const s=t.dx<0,i=t.dx>0,n=t.dy<0,a=t.dy>0,l="LEFT"===e,o="RIGHT"===e,h="TOP"===e,c="BOTTOM"===e,r=this.x,d=this.y,g=this.game.utils;a?(h&&this.isColliding(this,t,!1,!0)&&t.collision.top.push({obj:this,callback:this.collisionTop}),l&&i&&(g.catchBlockCollision(r-1,d)&&this.isColliding(g.catchBlockCollision(r-1,d),t,!1,!0)?t.collision.top.push({obj:this,callback:this.collisionTop}):t.collision.left.push({obj:this,callback:this.collisionLeft})),o&&s&&(g.catchBlockCollision(r+1,d)&&this.isColliding(g.catchBlockCollision(r+1,d),t,!1,!0)?t.collision.top.push({obj:this,callback:this.collisionTop}):t.collision.right.push({obj:this,callback:this.collisionRight}))):n?(c&&this.isColliding(this,t,!1,!0)&&t.collision.bottom.push({obj:this,callback:this.collisionBottom}),l&&(g.catchBlockCollision(r-1,d)&&this.isColliding(g.catchBlockCollision(r-1,d),t,!1,!0)?t.collision.bottom.push({obj:this,callback:this.collisionBottom}):t.collision.left.push({obj:this,callback:this.collisionLeft})),o&&(g.catchBlockCollision(r+1,d)&&this.isColliding(g.catchBlockCollision(r+1,d),t,!1,!0)?t.collision.bottom.push({obj:this,callback:this.collisionBottom}):t.collision.right.push({obj:this,callback:this.collisionRight}))):s&&o?t.collision.right.push({obj:this,callback:this.collisionRight}):i&&l&&t.collision.left.push({obj:this,callback:this.collisionLeft})}isColliding(t,e,s,i){const n=t.getLeft(),a=t.getRight(),l=t.getTop(),o=t.getBottom(),h=e.getLeft(s),c=e.getRight(s),r=e.getTop(i),d=e.getBottom(i);return n<c&&a>h&&l<d&&o>r}}class Player extends Block{constructor(t,e,s,i){super(t,e,i),this.type="Player",this.color="brown",this.name=s,this.h=100,this.w=50,this.camX=this.x,this.camY=this.y,this.hide=!1,this.respawn=[this.x,this.y],this.accel=ACCEL,this.maxSpeed=MAXSPEED,this.gravity=GRAVITY,this.jumpForce=JUMPFORCE,this.native={w:this.w,h:this.h,maxSpeed:this.maxSpeed},this.canJump=!0,this.isOnFloor=!1,this.isDead=!1,this.hasBounced=!1,this.isCrouching=!1,this.keys={38:!1,32:!1,90:!1,83:!1,40:!1,16:!1,39:!1,37:!1,81:!1,68:!1},this.collision={left:[],top:[],right:[],bottom:[]}}getLeft(t){return this.x+(t?this.dx:0)}getRight(t){return this.x+this.w+(t?this.dx:0)}getTop(t){return this.y+(t?this.dy:0)}getBottom(t){return this.y+this.h+(t?this.dy:0)}getHalfWidth(t){return this.x+this.w/2+(t?this.dx:0)}getHalfHeight(t){return this.y+this.h/2+(t?this.dy:0)}init(){this.x=this.respawn[0]*this.game.cfg.scale,this.y=this.respawn[1]*this.game.cfg.scale}jump(){this.isOnFloor&&this.canJump&&(this.dy=-this.jumpForce,this.isOnFloor=!1,this.canJump=!1)}crouch(){this.h=50,this.y+=this.h,this.maxSpeed*=.2,this.isCrouching=!0}uncrouch(){const t=this.game,e=t.cfg,s=Math.floor(this.x/e.scale),i=Math.floor((this.y-this.h)/e.scale),n=this.isColliding(t.static,i,s,this),a=this.isColliding(t.static,i,s+1,this);n||a||(this.y-=this.h,this.h=100,this.maxSpeed=this.native.maxSpeed,this.isCrouching=!1)}die(){this.x=this.respawn[0]*this.game.cfg.scale,this.y=this.respawn[1]*this.game.cfg.scale,this.dx=0,this.dy=0,this.isOnFloor=!1,this.hasBounced=!1,this.isDead=!0}spawn(){this.isDead=!1}draw(){if(this.isDead||this.hide)return;const t=this.game.c;t.beginPath(),t.rect(this.x,this.y,this.w,this.h),t.fillStyle=this.color,t.fill(),t.closePath()}move(t){this.isIdle=!0;const e=this.dx,s=(this.dy,this.isOnFloor),i=this.isCrouching,n=this.maxSpeed,a=this.accel,l=this.keys,o=!(!l[37]&&!l[81]),h=!!(l[38]||l[32]||l[90]),c=!(!l[39]&&!l[68]),r=!!(l[40]||l[83]||l[16]);if(!this.isDead&&!this.hide){if(o&&(i&&Math.abs(e)>n||(this.dx=Math.max(e-a,-n)),this.isIdle=!1),c&&(i&&Math.abs(e)>n||(this.dx=Math.min(e+a,n)),this.isIdle=!1),o&&c&&(this.dx=0),h?this.jump():this.canJump=!0,!i&&r&&this.crouch(),i&&!r&&this.uncrouch(),this.dy+=this.gravity*t,this.isIdle||i&&Math.abs(e)>n){let a=s?.02:.012;i&&Math.abs(e)>n&&(a=s?.0013:0),this.dx=this.game.utils.lerp(e,0,a*t)}if(0===this.game.window.play.startTime){Object.values(this.keys).some(t=>t)&&this.game.window.play.startTimer()}}}resolve(t,e){}update(t){if(this.isDead||this.hide)return;this.handleCollision(),this.dy>0&&(this.isOnFloor=!1);const e=this.game.cfg.scale,s=this.game.cfg.cols,i=this.game.cfg.rows;this.getLeft(!0)<0?(this.x=0,this.dx=0):this.getRight(!0)>s*e&&(this.x=s*e-this.w,this.dx=0),this.getTop(!0)<0?(this.y=0,this.dy=0):this.getBottom(!0)>i*e&&(this.y=i*e-this.h,this.isOnFloor=!0,this.dy=0),this.x+=this.dx*t,this.y+=this.dy*t,this.camX=this.x,this.camY=this.y,this.isCrouching&&(this.camY-=this.h/2)}isColliding(t,e,s,i){if(!t[e]||!t[e][s]&&0!=t[e][s])return!0;if("Wall"!=t[e][s].type)return!1;const n=t[e][s],a=n.getLeft(),l=n.getRight(),o=n.getTop(),h=n.getBottom(),c=this.getLeft(),r=this.getRight(),d=i?this.getTop()-this.h:this.getTop(),g=this.getBottom();return a<r&&l>c&&o<g&&h>d}handleCollision(){const t=this.collision.left,e=this.collision.top,s=this.collision.right,i=this.collision.bottom,n=t.length>0,a=e.length>0,l=s.length>0,o=i.length>0,h={x:this.dx,y:this.dy};if(a){const t={Spikes:!1,BouncingBox:!1,End:!1,Wall:!1};e.forEach(({obj:e,callback:s})=>{t.hasOwnProperty(e.type)&&(t[e.type]={obj:e,callback:s})});const s=Object.values(t).find(t=>t);s.callback(s.obj,this,{x:this.dx,y:this.dy},h)}o&&i.forEach(({obj:t,callback:e})=>{e(t,this,{x:this.dx,y:this.dy},h)}),n&&t.forEach(({obj:t,callback:e})=>{e(t,this,{x:this.dx,y:this.dy},h)}),l&&s.forEach(({obj:t,callback:e})=>{e(t,this,{x:this.dx,y:this.dy},h)}),this.collision.left=[],this.collision.top=[],this.collision.right=[],this.collision.bottom=[]}}class Spawn extends Block{constructor(t,e,s){super(t,e,s),this.h=2*s.cfg.scale,this.type="Spawn",this.color="brown",this.empty=!0,this.collision=!1,this.id=4,this.purpose=["Special"]}draw(){if("edit"===this.game.mode){const t=this.game.c,e=this.game.cfg.scale,s=this.x*e,i=this.y*e+(e-this.h);t.beginPath(),t.fillStyle=this.color,t.fillRect(s,i,this.w,this.h),t.closePath()}}editUpdate(){this.w=this.game.cfg.scale,this.h=2*this.game.cfg.scale}resolve(t,e){t.type}}class End extends Block{constructor(t,e,s){super(t,e,s),this.h=2*s.cfg.scale,this.type="End",this.color="cyan",this.empty=!1,this.collision=!0,this.id=5,this.purpose=["Special"]}update(){this.editUpdate()}draw(){const t=this.game,e=t.c,s=t.cfg.scale,i=this.x*s+(s-this.w),n=this.y*s+(s-this.h);e.beginPath(),e.fillStyle=this.color,e.lineWidth=1,e.rect(i,n,this.w+1,this.h+1),e.fill(),e.closePath()}editUpdate(){this.w=this.game.cfg.scale,this.h=2*this.game.cfg.scale}resolve(t,e){"Player"==t.type&&(this.game.window.play.endTimer(),t.dx=t.dy=0)}}class Wall extends Block{constructor(t,e,s){super(t,e,s),this.type="Wall",this.tile={name:this.game.select.tile.name},this.empty=!1,this.collision=!0,this.id=1,this.purpose=["Static"]}draw(){const t=this.game,e=t.c,s=t.assets.tiles[this.tile.name];e.drawImage(s.img,this.tile.x,this.tile.y,s.size,s.size,this.x*t.cfg.scale,this.y*t.cfg.scale,t.cfg.scale+1,t.cfg.scale+1)}editUpdate(){const t=this.game;if(this.w=t.cfg.scale,this.h=t.cfg.scale,this.tile){this.collision=this.tile.value<255;let e=this.game.utils.tileManager.getID(this.tile.value);this.tile.id=0===e?0:e-1;const s=this.tile.id%t.assets.tiles[this.tile.name].w,i=Math.floor(this.tile.id/t.assets.tiles[this.tile.name].w);this.tile.x=s*t.assets.tiles[this.tile.name].size+s*t.assets.tiles[this.tile.name].iX,this.tile.y=i*t.assets.tiles[this.tile.name].size+i*t.assets.tiles[this.tile.name].iY}}update(){const t=this.game;this.w=t.cfg.scale,this.h=t.cfg.scale}resolve(t,e){"Player"==t.type&&this.normalCollision(t,e)}}class Spikes extends Block{constructor(t,e,s){super(t,e,s),this.h=s.cfg.scale/2,this.type="Spikes",this.color="gray",this.empty=!1,this.collision=!0,this.id=3,this.purpose=["Static"]}update(){this.w=this.game.cfg.scale,this.h=this.game.cfg.scale/2}draw(){const t=this.game,e=t.c,s=t.cfg.scale,i=this.x*s,n=this.y*s+(s-this.h);e.beginPath(),e.drawImage(t.assets.textures.Spikes.img,i,n,this.w+1,this.h+1),e.closePath()}collisionTop(t,e,s,i){e.die()}resolve(t,e){"Player"==t.type&&this.normalCollision(t,e)}}class BouncingBox extends Block{constructor(t,e,s){super(t,e,s),this.h=s.cfg.scale/2,this.type="BouncingBox",this.color="purple",this.empty=!1,this.collision=!0,this.id=2,this.purpose=["Static"]}bounceFactor(t){return t.hasBounced?.7:1.1}update(){this.w=this.game.cfg.scale,this.h=this.game.cfg.scale/2}draw(){const t=this.game,e=t.c,s=t.cfg.scale,i=this.x*s,n=this.y*s+(s-this.h);e.beginPath(),e.drawImage(t.assets.textures.BouncingBox.img,i,n,this.w+1,this.h+1),e.closePath()}collisionLeft(t,e,s,i){e.dx>MAGNITUDEX?(e.dx*=-t.bounceFactor(e),e.hasBounced=!0):t.stopLeft(t,e)}collisionTop(t,e,s,i){e.dy>MAGNITUDEY?(e.dy*=-t.bounceFactor(e),e.isOnFloor=!0,e.hasBounced=!0):t.stopTop(t,e)}collisionRight(t,e,s,i){e.dx<-MAGNITUDEX?(e.dx*=-t.bounceFactor(e),e.hasBounced=!0):t.stopRight(t,e)}collisionBottom(t,e,s,i){e.dy<-MAGNITUDEY?(e.dy*=-t.bounceFactor(e),e.hasBounced=!0):t.stopBottom(t,e)}resolve(t,e){"Player"==t.type&&this.normalCollision(t,e)}}class SwordSupport extends Block{constructor(t,e,s){super(t,e,s),this.type="SwordSupport",this.color="gray",this.empty=!1,this.collision=!0,this.id=6,this.purpose=["Static"]}draw(){const t=this.game,e=t.c,s=t.cfg.scale,i=this.x*s+(s-this.w),n=this.y*s+(s-this.h);e.beginPath(),e.fillStyle=this.color,e.lineWidth=1,e.rect(i,n,this.w+1,this.h+1),e.fill(),e.closePath()}resolve(t,e){t.type}}class Sword extends Block{constructor(t,e,s){super(t,e,s);const i=s.cfg.scale;this.w=i/2,this.h=i/2,this.inX=i/2-this.w/2,this.inY=i/2-this.h/2,this.type="Sword",this.color="yellow",this.empty=!1,this.collision=!0,this.dx=.3,this.id=7,this.purpose=["Dynamic"],this.link="SwordSupport"}getLeft(t){return this.x*this.game.cfg.scale+this.inX+(t?this.dx:0)}getTop(t){return this.y*this.game.cfg.scale+this.inY+(t?this.dx:0)}update(t){const e=this.game,s=e.cfg.scale,i=!(this.dx>0),n=this.inX,a=this.dx;this.w=e.cfg.scale/2,this.h=e.cfg.scale/2,this.inX+=a*t,i&&n<0&&(this.game.dynamic[this.y][this.x]=0,this.x--,this.game.dynamic[this.y][this.x]=this,this.inX+=s),!i&&n>s&&(this.game.dynamic[this.y][this.x]=0,this.x++,this.game.dynamic[this.y][this.x]=this,this.inX-=s)}editUpdate(){const t=this.game.cfg.scale;this.inX=t/2-this.w/2,this.inY=t/2-this.h/2,this.w=t/2,this.h=t/2}draw(){const t=this.game.c,e=this.getLeft(),s=this.getTop(),i=this.w,n=this.h;t.beginPath(),t.fillStyle=this.color,t.fillRect(e,s,i,n),t.closePath()}resolve(t,e){const s=this.game,i=this.dx>0?1:0,n=s.static,a=!(this.dx>0),l=this.dx,o=this.x,h=this.y;switch(t.type){case"SwordSupport":if(n[h][o+i]&&"SwordSupport"===n[h][o+i].type)return;a&&this.getLeft()<t.getLeft()?this.dx=-l:!a&&this.getRight()>t.getRight()&&(this.dx=-l);break;case"Sword":this.dx=-l;break;case"Player":t.die()}}}function Game(t,e,s){var i=this,n=document.getElementById("game");this.canvas=document.createElement("canvas"),this.canvas.id="canvas",this.canvas.tabindex=1,this.canvas.innerHTML="You browser is too old to use canvas technologies.",n.appendChild(this.canvas),this.c=this.canvas.getContext("2d"),this.canvas.oncontextmenu=(t=>t.preventDefault()),this.canvas.width=innerWidth,this.canvas.height=innerHeight,this.cfg={name:t||"",time:e||null,edited:!1,cols:32,rows:32,scale:64,oldScale:64,updateArr:[[],[],[],[]],updateAll:!1},console.log("TIME =",this.cfg.time),this.utils={rand:(t,e)=>Math.floor(Math.random()*(e-t+1))+t,loadImg:t=>{let e=new Image;e.src=t.url,t.img=e},lerp:(t,e,s)=>{if(0===t)return!1;s=(s=s<0?0:s)>1?1:s;const i=Number((t+(e-t)*s).toFixed(5));return 0==Math.abs(i-e).toFixed(2)?e:i},getBlock:(t,e,s)=>!!t[s]&&(!(t[s]&&!t[s][e])&&!!t[s][e].collision),events:(t,e)=>{t.listen=(()=>{e.forEach(e=>t.game.canvas.addEventListener(e,t,!1))}),t.mute=(()=>{e.forEach(e=>t.game.canvas.removeEventListener(e,t,!1))}),t.handleEvent=(e=>{let s=`on${e.type}`;if("function"==typeof t[s])return e.preventDefault(),t[s](e)})},textSize:(t,e)=>[t.measureText(e).width,.7*parseInt(t.font.match(/\d+/),10)],mouseCollision:(t,e)=>{const s=t.x,i=s+t.w,n=t.y,a=n+t.h,l=e.x,o=e.y;return s<=l&&i>=l&&n<=o&&a>=o},catchBlockCollision:(t,e)=>{let s=!1;return["static","dynamic"].forEach(n=>{const a=i[n];if(!a[e]||!a[e][t]||!a[e][t].collision||"SwordSupport"===a[e][t].type)return!1;s=a[e][t]}),s},numberToClass:(t,e)=>{switch(e){case 0:return t.Objects.Block;case 1:return t.Objects.Wall;case 2:return t.Objects.BouncingBox;case 3:return t.Objects.Spikes;case 4:return t.Objects.Spawn;case 5:return t.Objects.End;default:return!1}},load:(t,e)=>{const s=new XMLHttpRequest;s.open("GET",t,!1),s.send(null),e.innerHTML=s.responseText},handleError:()=>{},tileManager:{getID:t=>{return{0:1,2:2,8:3,10:4,11:5,16:6,18:7,22:8,24:9,26:10,27:11,30:12,31:13,64:14,66:15,72:16,74:17,75:18,80:19,82:20,86:21,88:22,90:23,91:24,94:25,95:26,104:27,106:28,107:29,120:30,122:31,123:32,126:33,127:34,208:35,210:36,214:37,216:38,218:39,219:40,222:41,223:42,248:43,250:44,251:45,254:46,255:47}[t]},getValue(t,e,s,i=!1,n=!1){const a=t.static,l=t.map;let o=0,h=[];const c=[!1,!1,!1,!1];function r(e,s,i,r,d=!1){(!a[s]||a[s]&&!a[s][e])&&l[s]&&l[s][e]&&"1"!=l[s][e][1]||a[s]&&a[s][e]&&"Wall"!=a[s][e].type||a[s]&&a[s][e]&&a[s][e].empty||(o+=i,r>=0&&(c[r]=!0),n||a[s]&&a[s][e]&&(t.utils.tileManager.getValue(t,e,s,!1,!0),h.push({x:e,y:s})))}return r(e,s-1,2,0),r(e,s+1,64,1,!0),r(e-1,s,8,2),r(e+1,s,16,3),c[0]&&c[2]&&r(e-1,s-1,1),c[0]&&c[3]&&r(e+1,s-1,4),c[1]&&c[2]&&r(e-1,s+1,32),c[1]&&c[3]&&r(e+1,s+1,128),i||(a[s][e].tile.value=o),a[s][e]&&a[s][e].editUpdate(),h}}},this.map=s||"0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###,0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###-0###",this.firstInit=!0,this.background=[],this.static=[],this.dynamic=[],this.foreground=[],this.lastRender=null,this.now=null,this.resetAnimate=!0,this.Player=new Player(5,5,"Player1",this),this.Objects={Block:[Block,0,["background"]],Wall:[Wall,1,["static"]],BouncingBox:[BouncingBox,2,["static"]],Spikes:[Spikes,3,["static"]],Spawn:[Spawn,4,["special"]],End:[End,5,["special"]],SwordSupport:[SwordSupport,6,["static"]],Sword:[Sword,7,["dynamic"],"SwordSupport"]},this.editObjects=Object.values(this.Objects).filter(t=>"number"==typeof t[1]),this.mode="edit",this.Engine=new Engine(this.c,this.cfg.cols,this.cfg.rows,this.cfg.scale),this.Camera=new Camera(i),this.assets={tiles:{spaceGround:{name:"spaceGround",w:8,h:6,l:47,iX:10,iY:10,size:64,url:"./img/space-tileMap.png",img:null}},textures:{Spikes:{name:"Spikes",url:"./img/spikes.png",img:null},BouncingBox:{name:"BouncingBox",url:"./img/bouncingBox.png",img:null}}},this.translate={x:0,y:0},this.playing=[!1,!1],this.select={color:"blue",brushSize:0,block:null,tile:i.assets.tiles.spaceGround,layer:null},this.mouse={x:null,y:null,gridX:0,gridY:0,left:!1,right:!1,click:null,middle:{click:!1,x:null,y:null},last:{gridX:void 0,gridY:void 0,click:"nop"}},this.window={play:new PlayWindow(this),edit:new EditWindow(this)},this.mapInit={load:function(){var t=i;if(t.firstInit){let e=t.map.split(",");e.map((t,s)=>{e[s]=t.split("-"),e[s].map((t,i)=>{e[s][i]=t.split("")})}),t.map=e,t.cfg.cols=e[0].length,t.cfg.rows=e.length,t.firstInit=!1}for(let e=0;e<t.map.length;e++)for(let s=0;s<t.map[0].length;s++){const n=t.map[e][s],a=["background","static","dynamic","foreground"];n.forEach((n,l)=>{const o=t[a[l]];if(o[e]||(o[e]=[]),"#"===n)return o[e][s]=0;const h=t.editObjects.find(t=>t[1]==n);switch(n.toString()){case"1":o[e][s]=new h[0](s,e,t),i.utils.tileManager.getValue(t,s,e,!1,!1);break;case"4":t.Player.respawn=[s,e-1],o[e][s]=new h[0](s,e,t),t[a[0]][e][s]=new t.Objects.Block[0](s,e,t);break;default:o[e][s]=new h[0](s,e,t)}})}},save:function(){var t=i,e=[];["background","static","dynamic","foreground"].forEach((s,i)=>{t[s].forEach((t,s)=>{e[s]||(e[s]=[]),t.forEach((t,n)=>{e[s][n]||(e[s][n]=[]),e[s][n][i]=t?t.id:"#"})})}),t.map=e,t.cfg.cols=e[0].length,t.cfg.rows=e.length}};for(let t in i.assets.tiles)i.utils.loadImg(i.assets.tiles[t]);for(let t in i.assets.textures)i.utils.loadImg(i.assets.textures[t]);this.init=function(t=!1){t&&this.mapInit.save(this),this.mapInit.load(this),this.Player.init(),this.Camera=new Camera(this),console.log("Lets go !")};let a=0,l=0;setInterval(()=>{l=a,a=0},1e3);let o;var h=null;this.animate=function(t){t||(t=0);const e=t;i.resetAnimate&&(o=t),this.dt=e-o,this.dt>100&&(this.dt=100),"play"===i.mode?(i.window.play.update(this.dt),i.window.play.draw()):"edit"===i.mode&&i.window.edit.update(),a++,i.c.beginPath(),i.c.fillStyle="rgba(0, 0, 0, 0.5)",i.c.fillRect(i.canvas.width-80,0,100,40),i.c.fillStyle="white",i.c.font="11px Arial",i.c.fillText(`ZOOM: x${(i.cfg.scale/64).toFixed(2)}`,i.canvas.width-75,15),i.c.fillText(`FPS: ${l}`,i.canvas.width-75,30),i.c.rect(0,0,i.canvas.width,i.canvas.height),i.c.stroke(),i.c.closePath(),o=t,i.resetAnimate&&(i.resetAnimate=!1),i.playing[0]&&(h=window.requestAnimationFrame(i.animate))},this.play=(()=>{var t=document.getElementById("mapList"),e=document.getElementById("game");t.style.display="none",e.style.display="block",this.mode="play",this.init(),this.playing=[!0,!0],this.cfg.updateAll=!0,this.resetAnimate=!0,this.window.play.start(),this.animate()}),this.edit=(()=>{var t=document.getElementById("mapList"),e=document.getElementById("game");t.style.display="none",e.style.display="block",this.mode="edit",this.init(),this.playing=[!0,!0],this.cfg.updateAll=!0,this.window.edit.start(),this.animate()}),this.end=(()=>{for(el in this.window[this.mode].end(),window.cancelAnimationFrame(h),this.canvas.parentNode.removeChild(this.canvas),this)delete this[el];var t=document.getElementById("mapList"),e=document.getElementById("game");t.style.display="block",e.style.display="none"})}function gameMenu(t){const e=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style"),i="\n      #playMenu {\n        position: absolute;\n        width: 0;\n        top: 0;\n        bottom: 0;\n        left: 0;\n        background: rgba(15,15,15,0.99);\n        text-align: center;\n        overflow: hidden;\n        padding-top: 36vh;\n        padding-top: calc(50vh - (7vh*2+10));\n      }\n  \n      .playBtn {\n        display: block;\n        width: 20vw;\n        height: 7vh;\n        background: black;\n        color: white;\n        margin: 0 auto 10px auto;\n      }\n\n      #timer {\n        display: inline-block;\n        margin: 0;\n        position: absolute;\n        text-align: center;\n        top: 0;\n        left: 0;\n        width:100%;\n        padding: 10px 0;\n        color: white;\n        font-size: 2.3em;\n        font-weight: bold;\n        z-index: 1000;\n      }\n\n      #timer > span {\n        padding: 10px 20px;\n        background: rgba(0,0,0,0.7);\n      }\n    ";e.appendChild(s),s.type="text/css",s.id="stylePlay",s.styleSheet?s.styleSheet.cssText=i:s.appendChild(document.createTextNode(i));const n=document.getElementById("game"),a=(document.getElementById("canvas"),document.createElement("p"));a.id="timer";const l=document.createElement("span");l.innerHTML="00:00:00",a.appendChild(l),n.appendChild(a);const o=document.createElement("div");o.id="playMenu";const h=document.createElement("input");h.id="btnResume",h.type="button",h.classList.add("playBtn"),h.value="RESUME",h.onclick=(e=>{e.preventDefault(),t.window.play.pauseTimer(),o.style.width=0}),o.append(h);const c=document.createElement("input");c.id="btnRestart",c.type="button",c.classList.add("playBtn"),c.value="RESTART",c.onclick=(e=>{e.preventDefault(),t.window.play.gameReset()}),o.append(c);const r=document.createElement("input");return r.id="btnEdit",r.type="button",r.classList.add("playBtn"),r.value="EDIT MAP",r.onclick=(e=>{e.preventDefault(),t.window.play.end(),t.mode="edit",t.window.edit.start(),t.init(),t.playing=[!0,!0],t.cfg.updateAll=!0,t.canvas.focus(),t.animate(),t.cfg.edited=!0}),o.append(r),o}function toolbar(t){const e=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style"),i=`\n      #toolbar {\n        position: absolute;\n        top: 0;\n        bottom: 0;\n        left: 0;\n        background: rgba(15,15,15, 1);\n        overflow: hidden;\n        text-align: center;\n        padding-top: 20vh;\n      }\n  \n      #toolbar > * {\n        margin: 20px auto;\n      }\n  \n      .dispBlock {\n        display: block;\n      }\n  \n      #playH2 {\n        margin-bottom: 30px;\n      }\n  \n      #btnHide {\n        position: absolute;\n        padding: ${t.canvas.height/2-20}px 7px;\n        height: 100%;\n        top: 0;\n        right: 0;\n        background: black;\n        color: white;\n        margin: 0 auto;\n        text-decoration: none;\n      }\n  \n      .inputSpan > input {\n        width: 15%;\n      }\n  \n      #selectSpan > * {\n        display: block;\n        margin: auto;\n      }\n  \n      .playBtn {\n        border: 1px solid white;\n        padding: 10px 20px;\n        background: black;\n        font-weight: bold;\n        color: white;\n        margin: auto 5px !important;\n        cursor: pointer;\n      }\n  \n      #errorMsg {\n        color: red;\n        font-size: 1.1em;\n      }\n    `;e.appendChild(s),s.type="text/css",s.id="styleEdit",s.styleSheet?s.styleSheet.cssText=i:s.appendChild(document.createTextNode(i));const n=document.createElement("div");n.id="toolbar",n.style.width="25%";const a=document.createElement("a");a.id="btnHide",a.innerHTML="|||",a.href="",a.onclick=(t=>{t.preventDefault();const e=n.style.width.replace(/px|%/i,"");n.style.width=e>20?20:"25%"}),n.appendChild(a);const l=document.createElement("h2");l.innerHTML="SETTINGS:",l.id="playH2",n.appendChild(l);const o=document.createElement("span");o.innerHTML="Name: ",o.classList.add("dispBlock","inputSpan");const h=document.createElement("input");h.type="text",h.value=t.cfg.name,h.onchange=function(e){t.cfg.name=e.target.value},o.appendChild(h),n.appendChild(o);const c=["background","static","dynamic","foreground"],r=document.createElement("span");r.innerHTML="Row: ",r.classList.add("dispBlock","inputSpan");const d=document.createElement("input");d.type="number",d.value=t.cfg.rows,d.onchange=function(e){const s=e.target.value,i=[];c.forEach(e=>{const n=t[e];for(let a=0;a<s;a++)if(n[a])i[a]=n[a];else{i[a]=[];for(let s=0;s<t.cfg.cols;s++)i[a][s]="background"===e?new t.Objects.Block[0](s,a,t):0}t[e]=i}),t.cfg.rows=Number(s),t.cfg.updateAll=!0,t.translate.x=t.translate.y=0},r.appendChild(d),n.appendChild(r);const g=document.createElement("span");g.innerHTML="Col: ",g.classList.add("dispBlock","inputSpan");const m=document.createElement("input");m.type="number",m.value=t.cfg.cols,m.onchange=function(e){const s=e.target.value;c.forEach(e=>{const i=t[e];let n=[];for(let a=0;a<t.cfg.rows;a++){n[a]=[];for(let l=0;l<s;l++)i[a][l]?n[a][l]=i[a][l]:n[a][l]="background"===e?new t.Objects.Block[0](l,a,t):0}t[e]=n}),t.cfg.cols=Number(s),t.cfg.updateAll=!0,t.translate.x=t.translate.y=0},g.appendChild(m),n.appendChild(g);const u=["background","static","dynamic","foreground","special"],p=document.createElement("select");p.id="layerBlock";for(var y=0;y<u.length;y++){const t=document.createElement("option");t.value=u[y],t.text=u[y],p.appendChild(t)}p.value="static",t.select.layer="static",p.style.display="block",p.onchange=(e=>{const s=e.target.selectedIndex,i=e.target[s].value;t.select.layer=i,document.dispatchEvent(refreshBlockType)});const f=document.createElement("span");f.innerHTML="Layer ",f.classList.add("dispBlock"),f.id="selectSpan",f.appendChild(p),n.appendChild(f);const w=document.createElement("span");w.classList.add("dispBlock"),w.id="selectSpan",n.appendChild(w),window.refreshBlockType=new Event("refreshBlockType"),document.addEventListener("refreshBlockType",function(){w.innerHTML="Block Type: ";const e=document.createElement("select");e.id="selectBlock";const s=v("Spawn",t.static),i=v("End",t.static);let n=document.createElement("option");e.appendChild(n);for(var a=0;a<t.editObjects.length;a++){const l=t.editObjects[a],o=t.select.layer;l[2]==o&&((n=document.createElement("option")).value=l[0].name,n.text=l[0].name,4===l[1]&&s?n.disabled=!0:5===l[1]&&i&&(n.disabled=!0),e.appendChild(n))}e.style.display="block",e.onchange=(e=>{const s=e.target.selectedIndex,i=e.target[s].value;t.select.block=t.Objects[i]}),w.appendChild(e)},!1),document.dispatchEvent(refreshBlockType),document.createElement("input").type="text";const x=document.createElement("input");x.type="button",x.value="Play",x.classList.add("playBtn"),x.onclick=(e=>{const s=v("Spawn",t.static),i=v("End",t.static);if(!s||!i)return b.innerHTML=`You can't play without ${s?"End":"Spawn"} block !`;t.window[t.mode].end(),t.mode="play",t.init(!0),t.cfg.updateAll=!0,t.canvas.focus(),t.window.play.resetTimer(),t.Player.hide=!1,t.playing[0]||(t.playing[0]=!0,t.resetAnimate=!0,t.animate()),t.window.play.start()}),n.appendChild(x);const k=document.createElement("input");k.type="button",k.value="Save",k.classList.add("playBtn"),k.onclick=(e=>{if(!t.cfg.name)return b.innerHTML="You forgot to set the name !";let s="";var i=t.static,n=i[0].length,a=i.length;for(let e=0;e<i.length;e++){for(let n=0;n<i[0].length;n++)c.forEach((i,a)=>{const l=t[i];l[e][n]?s+=l[e][n].id:s+="#"}),s+=n+1<i[0].length?"-":"";s+=e+1<i.length?",":""}var l=new XMLHttpRequest;l.onloadend=(()=>{}),l.open("POST","/saveMap",!0),l.setRequestHeader("Content-type","application/json"),l.send(JSON.stringify({name:t.cfg.name,cols:n,rows:a,data:s}))}),n.appendChild(k);const b=document.createElement("span");return b.classList.add("dispBlock"),b.id="errorMsg",n.appendChild(b),n;function v(t,e){for(let s=0;s<e.length;s++)if(e[s].some(e=>e.type===t))return!0}}